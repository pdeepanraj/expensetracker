<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Expense Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 24px; }
    .row { display: flex; gap: 16px; flex-wrap: wrap; }
    .card { border: 1px solid #ddd; padding: 12px; border-radius: 8px; }
  </style>
</head>
<body>
  <h1>Expense Tracker</h1>

  <div class="card">
    <h3>Ingest from GitHub</h3>
    <label>CSV Raw URLs (one per line)</label><br/>
    <textarea id="urls" rows="4" style="width: 100%;"></textarea><br/>
    <label>Card Name</label>
    <input id="card" value="Uploaded" />
    <label>Categories JSON Raw URL</label>
    <input id="cat" style="width: 60%;" placeholder="https://raw.githubusercontent.com/.../categories_grouped.json" />
    <button id="ingest">Ingest</button>
    <div id="ingestStatus"></div>
  </div>

  <div class="card">
    <h3>Dashboard</h3>
    <div class="row">
      <label>Group by</label>
      <select id="g1">
        <option value="month">month</option>
        <option value="year">year</option>
        <option value="main_category" selected>main_category</option>
        <option value="sub_category">sub_category</option>
        <option value="card_name">card_name</option>
      </select>
      <select id="g2">
        <option value="">(none)</option>
        <option value="month">month</option>
        <option value="year">year</option>
        <option value="main_category">main_category</option>
        <option value="sub_category">sub_category</option>
        <option value="card_name">card_name</option>
      </select>
      <label>Aggregate</label>
      <select id="agg">
        <option value="sum" selected>sum</option>
        <option value="count">count</option>
        <option value="mean">mean</option>
        <option value="min">min</option>
        <option value="max">max</option>
        <option value="median">median</option>
      </select>
      <button id="refresh">Refresh</button>
    </div>
    <canvas id="chart" height="120"></canvas>
    <pre id="grid"></pre>
  </div>

<script>
async function ingest() {
  const urls = document.getElementById('urls').value.split(/\n+/).map(s => s.trim()).filter(Boolean);
  const card = document.getElementById('card').value.trim() || 'Uploaded';
  const cat  = document.getElementById('cat').value.trim();
  if (!urls.length || !cat) { alert('Provide at least one CSV URL and categories JSON URL'); return; }

  const params = new URLSearchParams();
  urls.forEach(u => params.append('csv_urls', u));
  params.append('card_name', card);
  params.append('categories_json_url', cat);

  const btn = document.getElementById('ingest');
  const st = document.getElementById('ingestStatus');
  btn.disabled = true; st.textContent = 'Loading...';
  try {
    const resp = await fetch('/ingest-from-github?' + params.toString(), { method: 'POST' });
    const data = await resp.json();
    st.textContent = JSON.stringify(data, null, 2);
  } catch (e) { st.textContent = String(e); }
  finally { btn.disabled = false; }
}

async function loadSummary() {
  const g1 = document.getElementById('g1').value;
  const g2 = document.getElementById('g2').value;
  const agg = document.getElementById('agg').value;

  const group = [g1, g2].filter(Boolean).join(',');
  const url = `/api/summary?group=${encodeURIComponent(group)}&agg=${agg}`;
  const resp = await fetch(url);
  const data = await resp.json();
  document.getElementById('grid').textContent = JSON.stringify(data.rows.slice(0,100), null, 2);

  // simple chart: x = first group field, y = value; if 2 dims, facet by second
  const gkeys = data.group;
  if (!gkeys.length) return;
  const labels = [...new Set(data.rows.map(r => String(r[gkeys[0]])))];
  const subKey = gkeys[1];

  let datasets;
  if (subKey) {
    const subVals = [...new Set(data.rows.map(r => String(r[subKey])))];
    datasets = subVals.map((s, i) => {
      const map = new Map();
      data.rows.filter(r => String(r[subKey]) === s).forEach(r => map.set(String(r[gkeys[0]]), r.value));
      return {
        label: s,
        data: labels.map(l => map.get(l) || 0),
        borderWidth: 1
      };
    });
  } else {
    const map = new Map(data.rows.map(r => [String(r[gkeys[0]]), r.value]));
    datasets = [{ label: `${gkeys[0]} ${data.agg}`, data: labels.map(l => map.get(l) || 0) }];
  }

  const ctx = document.getElementById('chart').getContext('2d');
  if (window._chart) window._chart.destroy();
  window._chart = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets },
    options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
  });
}

document.getElementById('ingest').addEventListener('click', ingest);
document.getElementById('refresh').addEventListener('click', loadSummary);
</script>
</body>
</html>
