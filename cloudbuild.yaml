# Cloud Build config for building to Container Registry (gcr.io)
# and deploying to Cloud Run (us-east1)

options:
  logging: CLOUD_LOGGING_ONLY

substitutions:
  _SERVICE: expense-bqry

steps:
  # Build the image and tag it in Container Registry
  - name: gcr.io/cloud-builders/docker
    args:
      - build
      - -t
      - gcr.io/$PROJECT_ID/${_SERVICE}:$SHORT_SHA
      - .

  # Push the image to Container Registry
  - name: gcr.io/cloud-builders/docker
    args:
      - push
      - gcr.io/$PROJECT_ID/${_SERVICE}:$SHORT_SHA

  # Deploy to Cloud Run (managed) in us-east1
  - name: gcr.io/google.com/cloudsdktool/cloud-sdk
    entrypoint: gcloud
    args:
      - run
      - deploy
      - ${_SERVICE}
      - --image=gcr.io/$PROJECT_ID/${_SERVICE}:$SHORT_SHA
      - --region=us-east1
      - --platform=managed
      - --allow-unauthenticated
      - --memory=1Gi
      - --cpu=1
      - --max-instances=1
      - --set-env-vars
      - BIGQUERY_DATASET=my_app_ds,BIGQUERY_TABLE_DETAILS=positive_monthly,BIGQUERY_TABLE_SUM_BY_CAT=summary_by_category,BIGQUERY_TABLE_SUM_BY_MAIN=summary_by_main,BIGQUERY_TABLE_TOTAL_POS_BY_MONTH=total_positive_by_month,BIGQUERY_TABLE_YEAR_MAIN_TOTALS=year_main_totals
      - --set-env-vars
      - GITHUB_OWNER=your-org,GITHUB_REPO=your-repo,GITHUB_BRANCH=main,GITHUB_DATA_PATH=data/input.csv,GITHUB_CONFIG_PATH=config/categories.json
      # If using a private GitHub repo, store a PAT in Secret Manager as "github-token"
      # and then uncomment the following line to inject it as GITHUB_TOKEN:
      # - --set-secrets=GITHUB_TOKEN=projects/$PROJECT_ID/secrets/github-token:latest

images:
  - gcr.io/$PROJECT_ID/${_SERVICE}:$SHORT_SHA
