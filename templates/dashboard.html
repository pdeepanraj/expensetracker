{% extends "base.html" %}
{% block title %}Expense Dashboard{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  /* Minimal page-local styles; core lives in style.css */
  .layout { display: grid; grid-template-columns: 280px 1fr; gap: 24px; }
  @media (max-width: 900px) { .layout { grid-template-columns: 1fr; } }
  @media (min-width: 901px) { .sidebar { position: sticky; top: 24px; align-self: start; } }
  .sidebar .card { margin-bottom: 24px; }
  .sidebar .grid-2 { grid-template-columns: 1fr; gap: 12px; }
  .accordion { border-top: 1px solid var(--border); margin-top: 8px; }
  .accordion-item { border-bottom: 1px solid var(--border); }
  .accordion-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 10px 0; font-weight: 600; }
  .accordion-header .chev { transition: transform 160ms ease; }
  .accordion-item[aria-expanded="true"] .chev { transform: rotate(90deg); }
  .accordion-panel { display: none; padding: 8px 0 12px; }
  .accordion-item[aria-expanded="true"] .accordion-panel { display: block; }
  .filters-toggle { display: none; margin-bottom: 12px; }
  @media (max-width: 900px) { .filters-toggle { display: inline-block; } .sidebar.collapsed { display: none; } }
</style>
{% endblock %}

{% block header_meta %}
Source: {{ project }}.{{ dataset }}.all_positive_monthly
{% endblock %}

{% block content %}
{% if loaded %}
<div class="card">
  <p><strong>Load result:</strong> {{ loaded }} new rows inserted.</p>
</div>
{% endif %}

{% if loaded or table_modified %}
<div class="card">
  {% if loaded %}
    <p><strong>Load result:</strong> {{ loaded }} new rows inserted.</p>
  {% endif %}
  {% if table_modified %}
    <p class="muted">Table last modified: {{ table_modified }}</p>
  {% endif %}
</div>
{% endif %}

<div class="card" style="padding: 16px; border: none; box-shadow: none; background: transparent; margin-bottom: 8px;">
  <h3 style="margin: 0 0 6px;">Your Expenses</h3>
  <p class="muted">Filter, group, and visualize your spend.</p>
</div>

<button id="filtersToggleBtn" class="btn secondary filters-toggle" type="button">Show filters</button>

<div class="layout">
  <!-- Sidebar -->
  <aside id="sidebar" class="sidebar collapsed">
    <div class="card">
      <h3>Filters</h3>
      <div class="accordion">
        <div class="accordion-item" aria-expanded="true">
          <div class="accordion-header">
            <span>Time</span>
            <span class="chev">›</span>
          </div>
          <div class="accordion-panel">
            <form method="get" action="/dashboard">
              <div class="grid-2">
                <div>
                  <label>Month</label>
                  <select name="month">
                    <option value="">All</option>
                    {% for m in months %}
                      <option value="{{ m }}" {% if selected_month == m %}selected{% endif %}>{{ m }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              <div class="actions">
                <button type="submit">Apply</button>
                <a class="btn secondary" href="/dashboard">Reset</a>
              </div>
            </form>
          </div>
        </div>

        <div class="accordion-item" aria-expanded="true">
          <div class="accordion-header">
            <span>Payment</span>
            <span class="chev">›</span>
          </div>
          <div class="accordion-panel">
            <form method="get" action="/dashboard">
              <div class="grid-2">
                <div>
                  <label>CardName</label>
                  <select name="card">
                    <option value="">All</option>
                    {% for c in cards %}
                      <option value="{{ c }}" {% if selected_card == c %}selected{% endif %}>{{ c }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              <div class="actions">
                <button type="submit">Apply</button>
                <a class="btn secondary" href="/dashboard">Reset</a>
              </div>
            </form>
          </div>
        </div>

        <div class="accordion-item" aria-expanded="true">
          <div class="accordion-header">
            <span>Categories</span>
            <span class="chev">›</span>
          </div>
          <div class="accordion-panel">
            <form method="get" action="/dashboard">
              <div class="grid-2">
                <div>
                  <label>MainCategory</label>
                  <select name="main">
                    <option value="">All</option>
                    {% for mc in mains %}
                      <option value="{{ mc }}" {% if selected_main == mc %}selected{% endif %}>{{ mc }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div>
                  <label>Category</label>
                  <select name="cat">
                    <option value="">All</option>
                    {% for ct in cats %}
                      <option value="{{ ct }}" {% if selected_cat == ct %}selected{% endif %}>{{ ct }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              <div class="actions">
                <button type="submit">Apply</button>
                <a class="btn secondary" href="/dashboard">Reset</a>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>Dynamic Grouping</h3>
      <div class="accordion">
        <div class="accordion-item" aria-expanded="true">
          <div class="accordion-header">
            <span>Group by</span>
            <span class="chev">›</span>
          </div>
          <div class="accordion-panel">
            <form method="get" action="/aggregate">
              <div class="grid-2">
                <div>
                  <div class="checkbox-group">
                    <label>
                      <input type="checkbox" name="group_by" value="Month"
                             {% if aggregate_group_by and 'Month' in aggregate_group_by.split(',') %}checked{% endif %}>
                      Month
                    </label>
                    <label>
                      <input type="checkbox" name="group_by" value="CardName"
                             {% if aggregate_group_by and 'CardName' in aggregate_group_by.split(',') %}checked{% endif %}>
                      CardName
                    </label>
                    <label>
                      <input type="checkbox" name="group_by" value="MainCategory"
                             {% if aggregate_group_by and 'MainCategory' in aggregate_group_by.split(',') %}checked{% endif %}>
                      MainCategory
                    </label>
                    <label>
                      <input type="checkbox" name="group_by" value="Category"
                             {% if (not aggregate_group_by) or 'Category' in aggregate_group_by.split(',') %}checked{% endif %}>
                      Category
                    </label>
                  </div>
                  <p class="muted">Select one or more grouping columns</p>
                </div>
                <div>
                  <label>Use current filters</label>
                  <div class="inline">
                    <select name="month">
                      <option value="">All</option>
                      {% for m in months %}
                        <option value="{{ m }}" {% if selected_month == m %}selected{% endif %}>{{ m }}</option>
                      {% endfor %}
                    </select>
                    <select name="card">
                      <option value="">All</option>
                      {% for c in cards %}
                        <option value="{{ c }}" {% if selected_card == c %}selected{% endif %}>{{ c }}</option>
                      {% endfor %}
                    </select>
                    <select name="main">
                      <option value="">All</option>
                      {% for mc in mains %}
                        <option value="{{ mc }}" {% if selected_main == mc %}selected{% endif %}>{{ mc }}</option>
                      {% endfor %}
                    </select>
                    <select name="cat">
                      <option value="">All</option>
                      {% for ct in cats %}
                        <option value="{{ ct }}" {% if selected_cat == ct %}selected{% endif %}>{{ ct }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <label for="min_amount">Minimum amount (optional)</label>
                  <input id="min_amount" name="min_amount" type="text" placeholder="e.g., 10" value="{{ aggregate_min_amount or '' }}">
                </div>
              </div>
              <div class="actions">
                <button type="submit">Run</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </aside>

  <!-- Content -->
  <section class="content">
    {% if aggregate_labels is defined and aggregate_labels %}
      <!-- Aggregate view: table first, graph second -->
      <div class="card">
        <h3>Aggregate Table{% if aggregate_group_by %} (Group by: {{ aggregate_group_by }}{% if aggregate_month %}, Month={{ aggregate_month }}{% endif %}){% endif %}</h3>
        <div class="table-scroll">
          <table>
            <thead>
              <tr>
                {% if aggregate_rows and aggregate_rows[0] %}
                  {% for k in aggregate_rows[0].keys() %}
                    <th>{{ k }}</th>
                  {% endfor %}
                {% else %}
                  <th>Group</th><th>Amount</th>
                {% endif %}
              </tr>
            </thead>
            <tbody>
              {% for r in aggregate_rows %}
              <tr>
                {% for v in r.values() %}
                <td>{{ v }}</td>
                {% endfor %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h3>Aggregate Chart</h3>
        <canvas id="aggChart" height="260"></canvas>
      </div>
    {% else %}
      <!-- Default view: table first, graph second -->
      <div class="card">
        <h3>Details{% if month_for_view %} ({{ month_for_view }}){% endif %}</h3>
        <input id="search" class="search" type="text" placeholder="Filter by text...">
        <div class="table-scroll">
          <table id="detailTable">
            <thead>
              <tr>
                <th>CardName</th>
                <th>MainCategory</th>
                <th>Category</th>
                <th>Description</th>
                <th>Amount</th>
              </tr>
            </thead>
            <tbody>
              {% for r in latest_details %}
              <tr>
                <td>{{ r.CardName }}</td>
                <td>{{ r.MainCategory }}</td>
                <td>{{ r.Category }}</td>
                <td>{{ r.Description }}</td>
                <td>{{ "%.2f"|format(r.Amount or 0) }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h3>Top Categories{% if month_for_view %} ({{ month_for_view }}){% endif %}</h3>
        <canvas id="catChart" height="260"></canvas>
      </div>

      <div class="card">
        <h3>Monthly Total Trend</h3>
        <canvas id="trendChart" height="260"></canvas>
      </div>
    {% endif %}
  </section>
</div>
{% endblock %}

{% block scripts %}
{% if aggregate_labels is defined and aggregate_labels %}
<script>
  // Thousand separators + 2 decimals formatter
  const fmt2 = new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

  const aggLabels = {{ aggregate_labels|tojson }};
  const aggValues = {{ aggregate_values|tojson }};

  new Chart(document.getElementById('aggChart'), {
    type: 'bar',
    data: {
      labels: aggLabels,
      datasets: [{ label: 'Amount', data: aggValues, backgroundColor: '#2d6cdf' }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => ' $' + fmt2.format(Number((ctx.parsed && ctx.parsed.y) ?? ctx.raw ?? 0))
          }
        }
      },
      scales: {
        y: { ticks: { callback: v => '$' + fmt2.format(Number(v)) } }
      }
    }
  });
</script>
{% else %}
<script>
  const fmt2 = new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

  const topCategories = {{ top_categories|tojson }};
  const monthlyTotals = {{ monthly_totals|tojson }};

  // Simple table filter
  const searchInput = document.getElementById('search');
  const table = document.getElementById('detailTable');
  if (searchInput && table) {
    searchInput.addEventListener('input', () => {
      const q = searchInput.value.toLowerCase();
      [...table.tBodies[0].rows].forEach(row => {
        const text = row.innerText.toLowerCase().replace(/\s+/g, ' ');
        row.style.display = text.includes(q) ? '' : 'none';
      });
    });
  }

  // Top categories bar chart (horizontal), after Details table
  const catLabels = topCategories.map(x => x.Category);
  const catValues = topCategories.map(x => x.Amount);
  new Chart(document.getElementById('catChart'), {
    type: 'bar',
    data: {
      labels: catLabels,
      datasets: [{ label: 'Amount', data: catValues, backgroundColor: '#4e79a7' }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => ' $' + fmt2.format(Number((ctx.parsed && ctx.parsed.x) ?? ctx.raw ?? 0))
          }
        }
      },
      scales: {
        x: { ticks: { callback: v => '$' + fmt2.format(Number(v)) } }
      }
    }
  });

  // Monthly totals line chart, after Top Categories chart
  const trendLabels = monthlyTotals.map(x => x.Month);
  const trendValues = monthlyTotals.map(x => x.Amount);
  new Chart(document.getElementById('trendChart'), {
    type: 'line',
    data: {
      labels: trendLabels,
      datasets: [{ label: 'Total', data: trendValues, borderColor: '#e15759', fill: false, tension: 0.2 }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => ' $' + fmt2.format(Number((ctx.parsed && ctx.parsed.y) ?? ctx.raw ?? 0))
          }
        }
      },
      scales: {
        y: { ticks: { callback: v => '$' + fmt2.format(Number(v)) } }
      }
    }
  });
</script>
{% endif %}

<script>
  // Mobile toggle for sidebar
  const toggleBtn = document.getElementById('filtersToggleBtn');
  const sidebar = document.getElementById('sidebar');
  if (toggleBtn && sidebar) {
    const syncLabel = () => {
      const collapsed = sidebar.classList.contains('collapsed');
      toggleBtn.textContent = collapsed ? 'Show filters' : 'Hide filters';
    };
    toggleBtn.addEventListener('click', () => {
      sidebar.classList.toggle('collapsed');
      syncLabel();
    });
    syncLabel();
  }

  // Accordions
  document.querySelectorAll('.accordion-header').forEach(h => {
    h.addEventListener('click', () => {
      const item = h.parentElement;
      const expanded = item.getAttribute('aria-expanded') === 'true';
      item.setAttribute('aria-expanded', expanded ? 'false' : 'true');
    });
  });
</script>
{% endblock %}
