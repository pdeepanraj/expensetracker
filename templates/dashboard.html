{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}

{% block header_meta %}
Source: {{ project }}.{{ dataset }}
{% endblock %}

{% block content %}

<!-- Tab bar -->
<div class="tabs">
  <a class="tab {% if tab=='details' or not tab %}active{% endif %}" href="{{ url_for('dashboard_details') }}">Details</a>
  <a class="tab {% if tab=='manual' %}active{% endif %}" href="{{ url_for('dashboard_manual') }}">Manual</a>
  <a class="tab {% if tab=='income' %}active{% endif %}" href="{{ url_for('dashboard_income') }}">Income</a>
  <a class="tab {% if tab=='aggregate' %}active{% endif %}" href="{{ url_for('aggregate') }}">Aggregate</a>
  <div class="tabs-spacer"></div>
  <div class="muted">Data Explorer</div>
</div>

<!-- Details tab -->
{% if tab=='details' or not tab %}
<div class="section">
  <h3>Details (Cards{% if include_manual %} + Manual{% endif %})</h3>
  <form method="get" action="{{ url_for('dashboard_details') }}" class="inline inline-end">
    <div>
      <label>Month</label><br>
      <select name="month">
        <option value="">All</option>
        {% for m in months %}<option value="{{ m }}" {% if selected_month==m %}selected{% endif %}>{{ m }}</option>{% endfor %}
      </select>
    </div>
    <div>
      <label>Card</label><br>
      <select name="card">
        <option value="">All</option>
        {% for c in cards %}<option value="{{ c }}" {% if selected_card==c %}selected{% endif %}>{{ c }}</option>{% endfor %}
      </select>
    </div>
    <div>
      <label>Main</label><br>
      <select name="main">
        <option value="">All</option>
        {% for mc in mains %}<option value="{{ mc }}" {% if selected_main==mc %}selected{% endif %}>{{ mc }}</option>{% endfor %}
      </select>
    </div>
    <div>
      <label>Category</label><br>
      <select name="cat">
        <option value="">All</option>
        {% for ct in cats %}<option value="{{ ct }}" {% if selected_cat==ct %}selected{% endif %}>{{ ct }}</option>{% endfor %}
      </select>
    </div>
    <label class="inline gap-6">
      <input type="checkbox" name="include_manual" value="1" {% if include_manual %}checked{% endif %}>
      Include manual spends
    </label>
    <div>
      <label>Sort</label><br>
      <select name="sort">
        {% set fields = ['Month','CardName','MainCategory','Category','Description','Amount'] %}
        {% for f in fields %}
        <option value="{{ f }}" {% if sort==f %}selected{% endif %}>{{ f }}</option>
        {% endfor %}
      </select>
      <select name="order">
        <option value="asc" {% if order=='asc' %}selected{% endif %}>Asc</option>
        <option value="desc" {% if order=='desc' %}selected{% endif %}>Desc</option>
      </select>
    </div>
    <div class="actions">
      <button class="btn btn-small secondary" type="submit">Apply</button>
      <a class="btn btn-small" href="{{ url_for('dashboard_details') }}">Reset</a>
    </div>
  </form>

  <div class="table-scroll mt-10">
    <table id="detailsTable">
      <thead>
        <tr>
          <th data-col="Month">Month</th>
          <th data-col="CardName">CardName</th>
          <th data-col="MainCategory">MainCategory</th>
          <th data-col="Category">Category</th>
          <th data-col="Description">Description</th>
          <th data-col="Amount">Amount</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
        <tr>
          <td>{{ r.Month }}</td>
          <td>{{ r.CardName }}</td>
          <td>{{ r.MainCategory }}</td>
          <td>{{ r.Category }}</td>
          <td>{{ r.Description }}</td>
          <td>{{ (r.Amount or 0)|currency }}</td>
        </tr>
        {% endfor %}
        {% if rows|length == 0 %}
        <tr><td colspan="6" class="muted">No data for current filters.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}

<!-- Manual tab -->
{% if tab=='manual' %}
<div class="section">
  <h3>Manual Spend</h3>
  <form method="get" action="{{ url_for('dashboard_manual') }}" class="inline inline-end">
    <div>
      <label>Month</label><br>
      <select name="month">
        <option value="">All</option>
        {% for m in months %}<option value="{{ m }}" {% if selected_month==m %}selected{% endif %}>{{ m }}</option>{% endfor %}
      </select>
    </div>
    <div>
      <label>Category</label><br>
      <select name="cat">
        <option value="">All</option>
        {% for c in cats %}<option value="{{ c }}" {% if selected_cat==c %}selected{% endif %}>{{ c }}</option>{% endfor %}
      </select>
    </div>
    <div>
      <label>Text contains</label><br>
      <input type="text" name="q" value="{{ q or '' }}" placeholder="Search description...">
    </div>
    <div>
      <label>Sort</label><br>
      <select name="sort">
        {% set fields = ['Month','Category','Description','Amount','Note'] %}
        {% for f in fields %}
        <option value="{{ f }}" {% if sort==f %}selected{% endif %}>{{ f }}</option>
        {% endfor %}
      </select>
      <select name="order">
        <option value="asc" {% if order=='asc' %}selected{% endif %}>Asc</option>
        <option value="desc" {% if order=='desc' %}selected{% endif %}>Desc</option>
      </select>
    </div>
    <div class="actions">
      <button class="btn btn-small secondary" type="submit">Apply</button>
      <a class="btn btn-small" href="{{ url_for('dashboard_manual') }}">Reset</a>
    </div>
  </form>

  <div class="table-scroll mt-10">
    <table id="manualTable">
      <thead>
        <tr>
          <th data-col="Month">Month</th>
          <th data-col="Category">Category</th>
          <th data-col="Description">Description</th>
          <th data-col="Amount">Amount</th>
          <th data-col="Note">Note</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
        <tr>
          <td>{{ r.Month }}</td>
          <td>{{ r.Category }}</td>
          <td>{{ r.Description }}</td>
          <td>{{ (r.Amount or 0)|currency }}</td>
          <td>{{ r.Note or NBSP }}</td>
        </tr>
        {% endfor %}
        {% if rows|length == 0 %}
        <tr><td colspan="5" class="muted">No manual spend for current filters.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}

<!-- Income tab -->
{% if tab=='income' %}
<div class="section">
  <h3>Income</h3>
  <form method="get" action="{{ url_for('dashboard_income') }}" class="inline inline-end">
    <div>
      <label>Month</label><br>
      <select name="month">
        <option value="">All</option>
        {% for m in months %}<option value="{{ m }}" {% if selected_month==m %}selected{% endif %}>{{ m }}</option>{% endfor %}
      </select>
    </div>
    <div>
      <label>Source</label><br>
      <select name="src">
        <option value="">All</option>
        {% for s in sources %}<option value="{{ s }}" {% if selected_src==s %}selected{% endif %}>{{ s }}</option>{% endfor %}
      </select>
    </div>
    <div>
      <label>Sort</label><br>
      <select name="sort">
        {% set fields = ['Month','Source','Amount','Note'] %}
        {% for f in fields %}
        <option value="{{ f }}" {% if sort==f %}selected{% endif %}>{{ f }}</option>
        {% endfor %}
      </select>
      <select name="order">
        <option value="asc" {% if order=='asc' %}selected{% endif %}>Asc</option>
        <option value="desc" {% if order=='desc' %}selected{% endif %}>Desc</option>
      </select>
    </div>
    <div class="actions">
      <button class="btn btn-small secondary" type="submit">Apply</button>
      <a class="btn btn-small" href="{{ url_for('dashboard_income') }}">Reset</a>
    </div>
  </form>

  <div class="table-scroll mt-10">
    <table id="incomeTable">
      <thead>
        <tr>
          <th data-col="Month">Month</th>
          <th data-col="Source">Source</th>
          <th data-col="Amount">Amount</th>
          <th data-col="Note">Note</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
        <tr>
          <td>{{ r.Month }}</td>
          <td>{{ r.Source }}</td>
          <td>{{ (r.Amount or 0)|currency }}</td>
          <td>{{ r.Note }}</td>
        </tr>
        {% endfor %}
        {% if rows|length == 0 %}
        <tr><td colspan="4" class="muted">No income for current filters.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}

<!-- Aggregate tab -->
{% if tab=='aggregate' %}
<div class="section">
  <h3>Aggregate</h3>
  <form method="get" action="{{ url_for('aggregate') }}" class="inline inline-start">
    <div>
      <label>Group by</label><br>
      <div>
        <label><input type="checkbox" name="group_by" value="Month" {% if aggregate_group_by and 'Month' in aggregate_group_by.split(',') %}checked{% endif %}> Month</label><br>
        <label><input type="checkbox" name="group_by" value="CardName" {% if aggregate_group_by and 'CardName' in aggregate_group_by.split(',') %}checked{% endif %}> CardName</label><br>
        <label><input type="checkbox" name="group_by" value="MainCategory" {% if aggregate_group_by and 'MainCategory' in aggregate_group_by.split(',') %}checked{% endif %}> MainCategory</label><br>
        <label><input type="checkbox" name="group_by" value="Category" {% if (not aggregate_group_by) or 'Category' in aggregate_group_by.split(',') %}checked{% endif %}> Category</label>
      </div>
    </div>
    <div>
      <label>Filters (cards)</label><br>
      <div class="inline">
        <select name="month">
          <option value="">All</option>
          {% for m in months %}
          <option value="{{ m }}" {% if selected_month == m %}selected{% endif %}>{{ m }}</option>
          {% endfor %}
        </select>
        <select name="card">
          <option value="">All</option>
          {% for c in cards %}
          <option value="{{ c }}" {% if selected_card == c %}selected{% endif %}>{{ c }}</option>
          {% endfor %}
        </select>
        <select name="main">
          <option value="">All</option>
          {% for mc in mains %}
          <option value="{{ mc }}" {% if selected_main == mc %}selected{% endif %}>{{ mc }}</option>
          {% endfor %}
        </select>
        <select name="cat">
          <option value="">All</option>
          {% for ct in cats %}
          <option value="{{ ct }}" {% if selected_cat == ct %}selected{% endif %}>{{ ct }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="mt-8">
        <label for="min_amount">Minimum amount (optional)</label><br>
        <input id="min_amount" name="min_amount" type="text" placeholder="e.g., 10" value="{{ aggregate_min_amount or '' }}">
      </div>
    </div>
    <div class="actions">
      <button class="btn btn-small secondary" type="submit">Run</button>
      <a class="btn btn-small" href="{{ url_for('aggregate') }}">Reset</a>
    </div>
  </form>

  <div class="table-scroll mt-10">
    <table>
      <thead>
        <tr>
          {% if aggregate_rows and aggregate_rows[0] %}
            {% for k in aggregate_rows[0].keys() %}
              <th>{{ k }}</th>
            {% endfor %}
          {% else %}
            <th>Group</th><th>Amount</th>
          {% endif %}
        </tr>
      </thead>
      <tbody>
        {% for r in aggregate_rows %}
          <tr>
            {% for k, v in r.items() %}
              {% if k == 'Amount' %}
                <td>{{ (v or 0)|currency }}</td>
              {% else %}
                <td>{{ v }}</td>
              {% endif %}
            {% endfor %}
          </tr>
        {% endfor %}
        {% if aggregate_rows|length == 0 %}
          <tr><td colspan="2" class="muted">Run a grouping to see results.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
// Simple client-side column sorter (enhances UX without reloading)
(function(){
  function attachSorter(tableId){
    const tbl = document.getElementById(tableId);
    if(!tbl) return;
    const getVal = (td, idx) => {
      const text = td.textContent.trim();
      if (tbl.tHead && tbl.tHead.rows[0].cells[idx] && tbl.tHead.rows[0].cells[idx].textContent.trim().toLowerCase()==='amount'){
        return parseFloat(text.replace(/[^0-9.-]/g,'')) || 0;
      }
      return text.toLowerCase();
    };
    if (!tbl.tHead) return;
    [...tbl.tHead.rows[0].cells].forEach((th, idx) => {
      th.addEventListener('click', ()=>{
        const rows = [...tbl.tBodies[0].rows];
        const asc = !th.classList.contains('asc');
        tbl.tHead.querySelectorAll('th').forEach(h=>h.classList.remove('asc','desc'));
        th.classList.add(asc?'asc':'desc');
        rows.sort((a,b)=>{
          const av = getVal(a.cells[idx], idx);
          const bv = getVal(b.cells[idx], idx);
          if (typeof av === 'number' && typeof bv === 'number') return asc ? av-bv : bv-av;
          return asc ? String(av).localeCompare(String(bv)) : String(bv).localeCompare(String(av));
        });
        rows.forEach(r=>tbl.tBodies[0].appendChild(r));
      });
    });
  }
  attachSorter('detailsTable');
  attachSorter('manualTable');
  attachSorter('incomeTable');
})();
</script>
{% endblock %}
