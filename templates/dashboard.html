{% extends "base.html" %}
{% block title %}Expense Dashboard{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
{% endblock %}

{% block header_meta %}
Source: {{ project }}.{{ dataset }}.all_positive_monthly
{% endblock %}

{% block content %}
{% if loaded %}
<div class="card">
  <p><strong>Load result:</strong> {{ loaded }} new rows inserted.</p>
</div>
{% endif %}

{% if loaded or table_modified %}
<div class="card">
  {% if loaded %}
    <p><strong>Load result:</strong> {{ loaded }} new rows inserted.</p>
  {% endif %}
  {% if table_modified %}
    <p class="muted">Table last modified: {{ table_modified }}</p>
  {% endif %}
</div>
{% endif %}

<div class="card" style="padding: 16px; border: none; box-shadow: none; background: transparent; margin-bottom: 8px;">
  <h3 style="margin: 0 0 6px;">Your Expenses</h3>
  <p class="muted">Filter, group, and visualize your spend.</p>
</div>

<button id="filtersToggleBtn" class="btn secondary filters-toggle" type="button">Show filters</button>

<div class="layout">
  <!-- Sidebar -->
  <aside id="sidebar" class="sidebar collapsed">
    <div class="card">
      <h3>Filters</h3>
      <div class="accordion">
        <div class="accordion-item" aria-expanded="true">
          <div class="accordion-header">
            <span>Time</span>
            <span class="chev">›</span>
          </div>
          <div class="accordion-panel">
            <form method="get" action="/dashboard">
              <div class="grid-2">
                <div>
                  <label>Month</label>
                  <select name="month">
                    <option value="">All</option>
                    {% for m in months %}
                      <option value="{{ m }}" {% if selected_month == m %}selected{% endif %}>{{ m }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              <div class="actions">
                <button type="submit">Apply</button>
                <a class="btn secondary" href="/dashboard">Reset</a>
              </div>
            </form>
          </div>
        </div>

        <div class="accordion-item" aria-expanded="true">
          <div class="accordion-header">
            <span>Payment</span>
            <span class="chev">›</span>
          </div>
          <div class="accordion-panel">
            <form method="get" action="/dashboard">
              <div class="grid-2">
                <div>
                  <label>CardName</label>
                  <select name="card">
                    <option value="">All</option>
                    {% for c in cards %}
                      <option value="{{ c }}" {% if selected_card == c %}selected{% endif %}>{{ c }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              <div class="actions">
                <button type="submit">Apply</button>
                <a class="btn secondary" href="/dashboard">Reset</a>
              </div>
            </form>
          </div>
        </div>

        <div class="accordion-item" aria-expanded="true">
          <div class="accordion-header">
            <span>Categories</span>
            <span class="chev">›</span>
          </div>
          <div class="accordion-panel">
            <form method="get" action="/dashboard">
              <div class="grid-2">
                <div>
                  <label>MainCategory</label>
                  <select name="main">
                    <option value="">All</option>
                    {% for mc in mains %}
                      <option value="{{ mc }}" {% if selected_main == mc %}selected{% endif %}>{{ mc }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div>
                  <label>Category</label>
                  <select name="cat">
                    <option value="">All</option>
                    {% for ct in cats %}
                      <option value="{{ ct }}" {% if selected_cat == ct %}selected{% endif %}>{{ ct }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              <div class="actions">
                <button type="submit">Apply</button>
                <a class="btn secondary" href="/dashboard">Reset</a>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>Dynamic Grouping</h3>
      <div class="accordion">
        <div class="accordion-item" aria-expanded="true">
          <div class="accordion-header">
            <span>Group by</span>
            <span class="chev">›</span>
          </div>
          <div class="accordion-panel">
            <form method="get" action="/aggregate">
              <div class="grid-2">
                <div>
                  <div class="checkbox-group">
                    <label>
                      <input type="checkbox" name="group_by" value="Month"
                             {% if aggregate_group_by and 'Month' in aggregate_group_by.split(',') %}checked{% endif %}>
                      Month
                    </label>
                    <label>
                      <input type="checkbox" name="group_by" value="CardName"
                             {% if aggregate_group_by and 'CardName' in aggregate_group_by.split(',') %}checked{% endif %}>
                      CardName
                    </label>
                    <label>
                      <input type="checkbox" name="group_by" value="MainCategory"
                             {% if aggregate_group_by and 'MainCategory' in aggregate_group_by.split(',') %}checked{% endif %}>
                      MainCategory
                    </label>
                    <label>
                      <input type="checkbox" name="group_by" value="Category"
                             {% if (not aggregate_group_by) or 'Category' in aggregate_group_by.split(',') %}checked{% endif %}>
                      Category
                    </label>
                  </div>
                  <p class="muted">Select one or more grouping columns</p>
                </div>
                <div>
                  <label>Use current filters</label>
                  <div class="inline">
                    <select name="month">
                      <option value="">All</option>
                      {% for m in months %}
                        <option value="{{ m }}" {% if selected_month == m %}selected{% endif %}>{{ m }}</option>
                      {% endfor %}
                    </select>
                    <select name="card">
                      <option value="">All</option>
                      {% for c in cards %}
                        <option value="{{ c }}" {% if selected_card == c %}selected{% endif %}>{{ c }}</option>
                      {% endfor %}
                    </select>
                    <select name="main">
                      <option value="">All</option>
                      {% for mc in mains %}
                        <option value="{{ mc }}" {% if selected_main == mc %}selected{% endif %}>{{ mc }}</option>
                      {% endfor %}
                    </select>
                    <select name="cat">
                      <option value="">All</option>
                      {% for ct in cats %}
                        <option value="{{ ct }}" {% if selected_cat == ct %}selected{% endif %}>{{ ct }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <label for="min_amount">Minimum amount (optional)</label>
                  <input id="min_amount" name="min_amount" type="text" placeholder="e.g., 10" value="{{ aggregate_min_amount or '' }}">
                </div>
              </div>
              <div class="actions">
                <button type="submit">Run</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </aside>

  <!-- Content -->
  <section class="content">
    {% if aggregate_labels is defined and aggregate_labels %}
      <!-- Aggregate: table first, chart second -->
      <div class="card">
        <h3>Aggregate Table{% if aggregate_group_by %} (Group by: {{ aggregate_group_by }}{% if aggregate_month %}, Month={{ aggregate_month }}{% endif %}){% endif %}</h3>
        <div class="table-scroll">
          <table>
            <thead>
              <tr>
                {% if aggregate_rows and aggregate_rows[0] %}
                  {% for k in aggregate_rows[0].keys() %}
                    <th>{{ k }}</th>
                  {% endfor %}
                {% else %}
                  <th>Group</th><th>Amount</th>
                {% endif %}
              </tr>
            </thead>
            <tbody>
  {% for r in aggregate_rows %}
  <tr>
    {% for k, v in r.items() %}
      {% if k == 'Amount' %}
        <td>{{ (v or 0)|currency }}</td>
      {% else %}
        <td>{{ v }}</td>
      {% endif %}
    {% endfor %}
  </tr>
  {% endfor %}
</tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h3>Aggregate Chart</h3>
        <canvas id="aggChart" height="260"></canvas>
      </div>
    {% else %}
      <!-- Default: table first, charts second -->
      <div class="card">
        <h3>Details{% if month_for_view %} ({{ month_for_view }}){% endif %}</h3>
        <input id="search" class="search" type="text" placeholder="Filter by text...">
        <div class="table-scroll">
          <table id="detailTable">
            <thead>
              <tr>
                <th>CardName</th>
                <th>MainCategory</th>
                <th>Category</th>
                <th>Description</th>
                <th>Amount</th>
              </tr>
            </thead>
            <tbody>
              {% for r in latest_details %}
              <tr>
                <td>{{ r.CardName }}</td>
                <td>{{ r.MainCategory }}</td>
                <td>{{ r.Category }}</td>
                <td>{{ r.Description }}</td>
                <td>{{ (r.Amount or 0)|currency }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h3>Top Categories{% if month_for_view %} ({{ month_for_view }}){% endif %}</h3>
        <canvas id="catChart" height="260"></canvas>
      </div>

      <div class="card">
        <h3>Monthly Total Trend</h3>
        <canvas id="trendChart" height="260"></canvas>
      </div>
    {% endif %}
  </section>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Utility to read CSS variables
  function cssVar(name) {
    return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
  }
  const fmt2 = new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

  // Build charts based on current theme (CSS vars)
  let charts = [];
  function destroyCharts() { charts.forEach(c => c.destroy()); charts = []; }

  {% if aggregate_labels is defined and aggregate_labels %}
    function buildAgg() {
      destroyCharts();
      const aggLabels = {{ aggregate_labels|tojson }};
      const aggValues = {{ aggregate_values|tojson }};
      charts.push(new Chart(document.getElementById('aggChart'), {
        type: 'bar',
        data: {
          labels: aggLabels,
          datasets: [{ label: 'Amount', data: aggValues, backgroundColor: cssVar('--primary') || '#2d6cdf' }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: cssVar('--chart-tooltip-bg') || '#1f2a44',
              titleColor: cssVar('--chart-tooltip-text') || '#fff',
              bodyColor: cssVar('--chart-tooltip-text') || '#fff',
              borderColor: cssVar('--chart-grid') || 'rgba(0,0,0,0.10)',
              borderWidth: 1,
              callbacks: {
                label: ctx => ' $' + fmt2.format(Number((ctx.parsed?.y ?? ctx.raw ?? 0)))
              }
            }
          },
          scales: {
            x: { grid: { color: cssVar('--chart-grid') || 'rgba(0,0,0,0.10)', drawBorder: false } },
            y: {
              grid: { color: cssVar('--chart-grid') || 'rgba(0,0,0,0.10)', drawBorder: false },
              ticks: { callback: v => '$' + fmt2.format(Number(v)) }
            }
          }
        }
      }));
    }
    buildAgg();
  {% else %}
    function buildDefault() {
      destroyCharts();
      const topCategories = {{ top_categories|tojson }};
      const monthlyTotals = {{ monthly_totals|tojson }};

      // Top categories (horizontal)
      const catLabels = topCategories.map(x => x.Category);
      const catValues = topCategories.map(x => x.Amount);
      charts.push(new Chart(document.getElementById('catChart'), {
        type: 'bar',
        data: {
          labels: catLabels,
          datasets: [{ label: 'Amount', data: catValues, backgroundColor: cssVar('--accent') || '#4e79a7' }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: cssVar('--chart-tooltip-bg') || '#1f2a44',
              titleColor: cssVar('--chart-tooltip-text') || '#fff',
              bodyColor: cssVar('--chart-tooltip-text') || '#fff',
              borderColor: cssVar('--chart-grid') || 'rgba(0,0,0,0.10)',
              borderWidth: 1,
              callbacks: {
                label: ctx => ' $' + fmt2.format(Number((ctx.parsed?.x ?? ctx.raw ?? 0)))
              }
            }
          },
          scales: {
            y: { grid: { color: cssVar('--chart-grid') || 'rgba(0,0,0,0.10)', drawBorder: false } },
            x: {
              grid: { color: cssVar('--chart-grid') || 'rgba(0,0,0,0.10)', drawBorder: false },
              ticks: { callback: v => '$' + fmt2.format(Number(v)) }
            }
          }
        }
      }));

      // Monthly totals line
      const trendLabels = monthlyTotals.map(x => x.Month);
      const trendValues = monthlyTotals.map(x => x.Amount);
      charts.push(new Chart(document.getElementById('trendChart'), {
        type: 'line',
        data: {
          labels: trendLabels,
          datasets: [{ label: 'Total', data: trendValues, borderColor: cssVar('--primary') || '#2d6cdf', fill: false, tension: 0.2 }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: cssVar('--chart-tooltip-bg') || '#1f2a44',
              titleColor: cssVar('--chart-tooltip-text') || '#fff',
              bodyColor: cssVar('--chart-tooltip-text') || '#fff',
              borderColor: cssVar('--chart-grid') || 'rgba(0,0,0,0.10)',
              borderWidth: 1,
              callbacks: {
                label: ctx => ' $' + fmt2.format(Number((ctx.parsed?.y ?? ctx.raw ?? 0)))
              }
            }
          },
          scales: {
            x: { grid: { color: cssVar('--chart-grid') || 'rgba(0,0,0,0.10)', drawBorder: false } },
            y: {
              grid: { color: cssVar('--chart-grid') || 'rgba(0,0,0,0.10)', drawBorder: false },
              ticks: { callback: v => '$' + fmt2.format(Number(v)) }
            }
          }
        }
      }));

      // Table filter
      const searchInput = document.getElementById('search');
      const table = document.getElementById('detailTable');
      if (searchInput && table) {
        searchInput.addEventListener('input', () => {
          const q = searchInput.value.toLowerCase();
          [...table.tBodies[0].rows].forEach(row => {
            const text = row.innerText.toLowerCase().replace(/\s+/g, ' ');
            row.style.display = text.includes(q) ? '' : 'none';
          });
        });
      }
    }
    buildDefault();
  {% endif %}

  // Rebuild charts on theme change
  window.addEventListener('theme-changed', () => {
    {% if aggregate_labels is defined and aggregate_labels %}
      buildAgg();
    {% else %}
      buildDefault();
    {% endif %}
  });

  // Mobile toggle for sidebar
  const toggleBtn = document.getElementById('filtersToggleBtn');
  const sidebar = document.getElementById('sidebar');
  if (toggleBtn && sidebar) {
    const syncLabel = () => {
      const collapsed = sidebar.classList.contains('collapsed');
      toggleBtn.textContent = collapsed ? 'Show filters' : 'Hide filters';
    };
    toggleBtn.addEventListener('click', () => {
      sidebar.classList.toggle('collapsed');
      syncLabel();
    });
    syncLabel();
  }

  // Accordions
  document.querySelectorAll('.accordion-header').forEach(h => {
    h.addEventListener('click', () => {
      const item = h.parentElement;
      const expanded = item.getAttribute('aria-expanded') === 'true';
      item.setAttribute('aria-expanded', expanded ? 'false' : 'true');
    });
  });
</script>
<script>
  // Thousand-separator table formatter
  (function() {
    const fmtCurrency = v => {
      const n = Number(v);
      if (isNaN(n)) return v;
      return '$' + new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n);
    };
    const fmtInteger = v => {
      const n = Number(v);
      if (isNaN(n)) return v;
      return new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 }).format(n);
    };

    function formatTable(tableEl) {
      if (!tableEl) return;
      const headers = [...tableEl.tHead?.rows[0]?.cells || []].map(th => th.textContent.trim());
      if (headers.length === 0) return;
      const amountIdxs = headers
        .map((h, i) => (/^amount$/i.test(h) ? i : -1))
        .filter(i => i >= 0);
      const countIdxs = headers
        .map((h, i) => (/^rowcount$/i.test(h) ? i : -1))
        .filter(i => i >= 0);

      [...tableEl.tBodies].forEach(tb => {
        [...tb.rows].forEach(row => {
          amountIdxs.forEach(i => {
            const td = row.cells[i];
            if (td) td.textContent = fmtCurrency(td.textContent);
          });
          countIdxs.forEach(i => {
            const td = row.cells[i];
            if (td) td.textContent = fmtInteger(td.textContent);
          });
        });
      });
    }

    // Format aggregate table (if present)
    const aggTable = document.querySelector('.content table'); // first table in content
    formatTable(aggTable);

    // Format details table
    const detailTable = document.getElementById('detailTable');
    formatTable(detailTable);
  })();
</script>


{% endblock %}
