{% extends "base.html" %}
{% block title %}Expense Dashboard{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
{% endblock %}

{% block header_meta %}
Source: {{ project }}.{{ dataset }}.all_positive_monthly
{% endblock %}

{% block content %}
{% if loaded %}
<div class="card">
  <p><strong>Load result:</strong> {{ loaded }} new rows inserted.</p>
</div>
{% endif %}

{% if loaded or table_modified %}
<div class="card">
  {% if loaded %}
    <p><strong>Load result:</strong> {{ loaded }} new rows inserted.</p>
  {% endif %}
  {% if table_modified %}
    <p class="muted">Table last modified: {{ table_modified }}</p>
  {% endif %}
</div>
{% endif %}

<!-- Controls row: Filters + Dynamic Grouping side by side -->
<div class="grid-2">
  <!-- Filters -->
  <div class="card">
    <h3>Filters</h3>
    <form method="get" action="/dashboard">
      <div class="grid-2">
        <div>
          <label>Month</label>
          <select name="month">
            <option value="">All</option>
            {% for m in months %}
              <option value="{{ m }}" {% if selected_month == m %}selected{% endif %}>{{ m }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label>CardName</label>
          <select name="card">
            <option value="">All</option>
            {% for c in cards %}
              <option value="{{ c }}" {% if selected_card == c %}selected{% endif %}>{{ c }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label>MainCategory</label>
          <select name="main">
            <option value="">All</option>
            {% for mc in mains %}
              <option value="{{ mc }}" {% if selected_main == mc %}selected{% endif %}>{{ mc }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label>Category</label>
          <select name="cat">
            <option value="">All</option>
            {% for ct in cats %}
              <option value="{{ ct }}" {% if selected_cat == ct %}selected{% endif %}>{{ ct }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="actions">
        <button type="submit">Apply</button>
        <a class="btn secondary" href="/dashboard">Reset</a>
      </div>
    </form>
  </div>

  <!-- Dynamic Grouping -->
  <div class="card">
    <h3>Dynamic Grouping</h3>
    <form method="get" action="/aggregate">
      <div class="grid-2">
        <div>
          <label>Group by</label>
          <div class="checkbox-group">
            <label>
              <input type="checkbox" name="group_by" value="Month"
                     {% if aggregate_group_by and 'Month' in aggregate_group_by.split(',') %}checked{% endif %}>
              Month
            </label>
            <label>
              <input type="checkbox" name="group_by" value="CardName"
                     {% if aggregate_group_by and 'CardName' in aggregate_group_by.split(',') %}checked{% endif %}>
              CardName
            </label>
            <label>
              <input type="checkbox" name="group_by" value="MainCategory"
                     {% if aggregate_group_by and 'MainCategory' in aggregate_group_by.split(',') %}checked{% endif %}>
              MainCategory
            </label>
            <label>
              <input type="checkbox" name="group_by" value="Category"
                     {% if (not aggregate_group_by) or 'Category' in aggregate_group_by.split(',') %}checked{% endif %}>
              Category
            </label>
          </div>
          <p class="muted">Select one or more grouping columns</p>
        </div>
        <div>
          <label>Use current filters</label>
          <div class="inline">
            <select name="month">
              <option value="">All</option>
              {% for m in months %}
                <option value="{{ m }}" {% if selected_month == m %}selected{% endif %}>{{ m }}</option>
              {% endfor %}
            </select>
            <select name="card">
              <option value="">All</option>
              {% for c in cards %}
                <option value="{{ c }}" {% if selected_card == c %}selected{% endif %}>{{ c }}</option>
              {% endfor %}
            </select>
            <select name="main">
              <option value="">All</option>
              {% for mc in mains %}
                <option value="{{ mc }}" {% if selected_main == mc %}selected{% endif %}>{{ mc }}</option>
              {% endfor %}
            </select>
            <select name="cat">
              <option value="">All</option>
              {% for ct in cats %}
                <option value="{{ ct }}" {% if selected_cat == ct %}selected{% endif %}>{{ ct }}</option>
              {% endfor %}
            </select>
          </div>
          <label for="min_amount">Minimum amount (optional)</label>
          <input id="min_amount" name="min_amount" type="text" placeholder="e.g., 10" value="{{ aggregate_min_amount or '' }}">
        </div>
      </div>
      <div class="actions">
        <button type="submit">Run</button>
      </div>
    </form>
  </div>
</div>

{% if aggregate_labels is defined and aggregate_labels %}
  <!-- Aggregate row: chart and table aligned -->
  <div class="grid-2">
    <div class="card">
      <h3>Aggregate Results{% if aggregate_group_by %} (Group by: {{ aggregate_group_by }}{% if aggregate_month %}, Month={{ aggregate_month }}{% endif %}){% endif %}</h3>
      <canvas id="aggChart" height="260"></canvas>
    </div>

    <div class="card">
      <h3>Aggregate Table</h3>
      <div class="table-scroll">
        <table>
          <thead>
            <tr>
              {% if aggregate_rows and aggregate_rows[0] %}
                {% for k in aggregate_rows[0].keys() %}
                  <th>{{ k }}</th>
                {% endfor %}
              {% else %}
                <th>Group</th><th>Amount</th>
              {% endif %}
            </tr>
          </thead>
          <tbody>
            {% for r in aggregate_rows %}
            <tr>
              {% for v in r.values() %}
              <td>{{ v }}</td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
{% else %}
  <!-- Default charts row -->
  <div class="grid-2">
    <div class="card">
      <h3>Top Categories{% if month_for_view %} ({{ month_for_view }}){% endif %}</h3>
      <canvas id="catChart" height="260"></canvas>
    </div>

    <div class="card">
      <h3>Monthly Total Trend</h3>
      <canvas id="trendChart" height="260"></canvas>
    </div>
  </div>

  <!-- Details table full-width -->
  <div class="card">
    <h3>Details{% if month_for_view %} ({{ month_for_view }}){% endif %}</h3>
    <input id="search" class="search" type="text" placeholder="Filter by text...">
    <div class="table-scroll">
      <table id="detailTable">
        <thead>
          <tr>
            <th>CardName</th>
            <th>MainCategory</th>
            <th>Category</th>
            <th>Description</th>
            <th>Amount</th>
          </tr>
        </thead>
        <tbody>
          {% for r in latest_details %}
          <tr>
            <td>{{ r.CardName }}</td>
            <td>{{ r.MainCategory }}</td>
            <td>{{ r.Category }}</td>
            <td>{{ r.Description }}</td>
            <td>{{ "%.2f"|format(r.Amount or 0) }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% endif %}
{% endblock %}

{% block scripts %}
{% if aggregate_labels is defined and aggregate_labels %}
<script>
  const aggLabels = {{ aggregate_labels|tojson }};
  const aggValues = {{ aggregate_values|tojson }};
  new Chart(document.getElementById('aggChart'), {
    type: 'bar',
    data: {
      labels: aggLabels,
      datasets: [{ label: 'Amount', data: aggValues, backgroundColor: '#2d6cdf' }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => ' $' + Number((ctx.parsed && ctx.parsed.y) ?? ctx.raw ?? 0).toFixed(2)
          }
        }
      },
      scales: {
        y: {
          ticks: {
            callback: v => '$' + Number(v).toFixed(2)
          }
        }
      }
    }
  });
</script>
{% else %}
<script>
  const topCategories = {{ top_categories|tojson }};
  const monthlyTotals = {{ monthly_totals|tojson }};

  // Top categories bar chart (horizontal)
  const catLabels = topCategories.map(x => x.Category);
  const catValues = topCategories.map(x => x.Amount);
  new Chart(document.getElementById('catChart'), {
    type: 'bar',
    data: {
      labels: catLabels,
      datasets: [{ label: 'Amount', data: catValues, backgroundColor: '#4e79a7' }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => ' $' + Number((ctx.parsed && ctx.parsed.x) ?? ctx.raw ?? 0).toFixed(2)
          }
        }
      },
      scales: {
        x: {
          ticks: { callback: v => '$' + Number(v).toFixed(2) }
        }
      }
    }
  });

  // Monthly totals line chart
  const trendLabels = monthlyTotals.map(x => x.Month);
  const trendValues = monthlyTotals.map(x => x.Amount);
  new Chart(document.getElementById('trendChart'), {
    type: 'line',
    data: {
      labels: trendLabels,
      datasets: [{ label: 'Total', data: trendValues, borderColor: '#e15759', fill: false, tension: 0.2 }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => ' $' + Number((ctx.parsed && ctx.parsed.y) ?? ctx.raw ?? 0).toFixed(2)
          }
        }
      },
      scales: {
        y: {
          ticks: { callback: v => '$' + Number(v).toFixed(2) }
        }
      }
    }
  });

  // Simple table filter
  const searchInput = document.getElementById('search');
  const table = document.getElementById('detailTable');
  searchInput.addEventListener('input', () => {
    const q = searchInput.value.toLowerCase();
    [...table.tBodies[0].rows].forEach(row => {
      const text = row.innerText.toLowerCase().replace(/\s+/g, ' ');
      row.style.display = text.includes(q) ? '' : 'none';
    });
  });
</script>
{% endif %}
{% endblock %}
