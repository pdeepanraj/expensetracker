{% extends "base.html" %}
{% block title %}Data Sources{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
{% endblock %}

{% block content %}
<div class="card card-plain mb-8">
  <h3 class="mb-6">Data Sources</h3>
  <p class="muted">Choose from a GitHub repository or upload local files.</p>
</div>

<!-- Tab bar -->
<div class="tabs" role="tablist">
  <button class="tab active"
          type="button"
          data-tab="github"
          role="tab"
          tabindex="0"
          aria-selected="true">
    GitHub Repository
  </button>
  <button class="tab"
          type="button"
          data-tab="upload"
          role="tab"
          tabindex="-1"
          aria-selected="false">
    Local Upload
  </button>
  <div class="tabs-spacer"></div>
  <div class="muted">Index</div>
</div>

<!-- GitHub repo listing -->
<div class="section" id="tab-github">
  <h3>Select GitHub Repository</h3>
  <form method="get" action="{{ url_for('list_csvs') }}" class="inline inline-start">
    <div class="form-field">
      <label>Owner (user or org)</label>
      <input type="text" name="owner" required placeholder="octocat">
    </div>
    <div class="form-field">
      <label>Repo</label>
      <input type="text" name="repo" required placeholder="hello-world">
    </div>
    <div class="form-field">
      <label>Branch (default main)</label>
      <input type="text" name="branch" placeholder="main">
    </div>
    <div class="form-field flex-1 min-260">
      <label>Path (folder within repo, default root)</label>
      <input type="text" name="path" placeholder="">
    </div>
    <div>
      <button class="btn secondary" type="submit">List CSV files</button>
    </div>
  </form>
</div>

<!-- Local upload -->
<div class="section hidden" id="tab-upload">
  <h3>Upload Local Files</h3>
  <p class="muted">Upload CSV or Excel files to process without GitHub.</p>
  <form method="post" action="{{ url_for('upload') }}" enctype="multipart/form-data" class="inline inline-start">
    <div class="form-field flex-1 min-320">
      <label>Files (CSV or Excel)</label>
      <input type="file" name="files" multiple accept=".csv, .xls, .xlsx">
    </div>
    <div class="form-field flex-1 min-320">
      <label>categories_grouped.json (optional)</label>
      <input type="file" name="json_cfg" accept=".json">
      <span class="muted small-note">Note: your app now reads categories from BigQuery; this file is optional.</span>
    </div>
    <div>
      <button class="btn secondary" type="submit">Run Pipeline</button>
    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
// Tabs: roving tabindex + panel toggle
(function(){
  const tabs = Array.from(document.querySelectorAll('.tabs .tab'));
  const panels = {
    github: document.getElementById('tab-github'),
    upload: document.getElementById('tab-upload')
  };

  function show(name){
    tabs.forEach(t => {
      const isActive = t.dataset.tab === name;
      t.classList.toggle('active', isActive);
      t.setAttribute('aria-selected', isActive ? 'true' : 'false');
      t.setAttribute('tabindex', isActive ? '0' : '-1');
    });
    Object.entries(panels).forEach(([k, el]) => {
      if (!el) return;
      el.classList.toggle('hidden', k !== name);
    });
  }

  // Click
  tabs.forEach(t => t.addEventListener('click', () => show(t.dataset.tab)));

  // Keyboard: Left/Right arrow to switch
  const keyNav = (e) => {
    const idx = tabs.findIndex(t => t.classList.contains('active'));
    if (e.key === 'ArrowRight') {
      e.preventDefault();
      const next = tabs[(idx + 1) % tabs.length];
      next.focus(); show(next.dataset.tab);
    } else if (e.key === 'ArrowLeft') {
      e.preventDefault();
      const prev = tabs[(idx - 1 + tabs.length) % tabs.length];
      prev.focus(); show(prev.dataset.tab);
    }
  };
  document.querySelector('.tabs').addEventListener('keydown', keyNav);

  // Default
  show('github');
})();
</script>
{% endblock %}
