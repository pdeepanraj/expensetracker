{% extends "base.html" %}
{% block title %}Review & Adjust{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/review.css') }}">
{% endblock %}

{% block header_meta %}
{{ project }}.{{ dataset }}.all_positive_monthly
{% endblock %}

{% block content %}
<div class="card card-plain mb-8">
  <h3 class="mb-6">Review & Adjust</h3>
  <p class="muted">Select a transaction, enter a percentage and optional note, preview your share, then apply the change to BigQuery.</p>
</div>

{% if message %}
<div class="card {{ 'border-default' if message_type != 'error' else 'border-error' }}">
  <p class="{{ 'muted' if message_type != 'error' else 'error' }}">{{ message }}</p>
</div>
{% endif %}

<!-- Tab bar -->
<div class="tabs" role="tablist">
  <button class="tab active" data-tab="filters" role="tab" tabindex="0" aria-selected="true">Filters</button>
  <button class="tab" data-tab="transactions" role="tab" tabindex="-1" aria-selected="false">Transactions</button>
  <button class="tab" data-tab="review" role="tab" tabindex="-1" aria-selected="false">Review Box</button>
  <div class="tabs-spacer"></div>
  <div class="muted">Review</div>
</div>

<!-- Filters -->
<div class="section" id="tab-filters">
  <h3>Filters</h3>
  <form method="get" action="{{ url_for('review_get') }}" class="inline inline-end">
    <div>
      <label>Month</label><br>
      <select name="month">
        <option value="">All</option>
        {% for m in months %}
          <option value="{{ m }}" {% if selected_month == m %}selected{% endif %}>{{ m }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label>CardName</label><br>
      <select name="card">
        <option value="">All</option>
        {% for c in cards %}
          <option value="{{ c }}" {% if selected_card == c %}selected{% endif %}>{{ c }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label>MainCategory</label><br>
      <select name="main">
        <option value="">All</option>
        {% for mc in mains %}
          <option value="{{ mc }}" {% if selected_main == mc %}selected{% endif %}>{{ mc }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label>Category</label><br>
      <select name="cat">
        <option value="">All</option>
        {% for ct in cats %}
          <option value="{{ ct }}" {% if selected_cat == ct %}selected{% endif %}>{{ ct }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <button class="btn secondary" type="submit">Load</button>
      <a class="btn" href="{{ url_for('review_get') }}">Reset</a>
    </div>
  </form>
</div>

<!-- Transactions table -->
<div class="section hidden" id="tab-transactions">
  <h3>Transactions{% if selected_month %} ({{ selected_month }}){% else %} (All){% endif %}</h3>
  <div class="table-scroll">
    <table id="reviewTable">
      <thead>
        <tr>
          <th>Month</th>
          <th>CardName</th>
          <th>MainCategory</th>
          <th>Category</th>
          <th>Description</th>
          <th>Amount</th>
          <th>Comment</th>
        </tr>
      </thead>
      <tbody>
        {% for r in review_rows %}
        <tr class="selectable"
            data-rowhash="{{ r.RowHash }}"
            data-month="{{ r.Month }}"
            data-card="{{ r.CardName }}"
            data-main="{{ r.MainCategory }}"
            data-cat="{{ r.Category }}"
            data-desc="{{ r.Description }}"
            data-amount="{{ r.Amount or 0 }}"
            data-comment="{{ r.Comment or '' }}">
          <td>{{ r.Month }}</td>
          <td>{{ r.CardName }}</td>
          <td>{{ r.MainCategory }}</td>
          <td>{{ r.Category }}</td>
          <td>{{ r.Description }}</td>
          <td>{{ (r.Amount or 0)|currency }}</td>
          <td>{{ r.Comment }}</td>
        </tr>
        {% endfor %}
        {% if not review_rows %}
        <tr><td colspan="7" class="muted">No rows loaded. Choose filters in the Filters tab and click Load.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
  <p class="muted mt-8">Tip: click a row to open it in the Review Box tab.</p>
</div>

<!-- Review Box -->
<div class="section hidden" id="tab-review">
  <h3>Review Box</h3>
  <p class="muted" id="panelHint">Select a row from the Transactions tab.</p>

  <div id="panelContent" class="hidden">
    <div class="grid-2">
      <div>
        <div class="pill mb-6"><strong>Month:</strong> <span id="pMonth"></span></div><br>
        <div class="pill mb-6"><strong>Card:</strong> <span id="pCard"></span></div><br>
        <div class="pill mb-6"><strong>Main:</strong> <span id="pMain"></span></div><br>
        <div class="pill"><strong>Category:</strong> <span id="pCat"></span></div>
      </div>
      <div>
        <p><strong>Description:</strong> <span id="pDesc"></span></p>
        <p><strong>Original Amount:</strong> <span id="pAmount"></span></p>
        <p><strong>Existing Comment:</strong> <span id="pComment"></span></p>
      </div>
    </div>

    <hr class="hr mt-12">

    <form method="post" action="{{ url_for('review_post') }}" id="reviewForm" class="inline inline-start">
      <input type="hidden" name="rowhash" id="fRowhash">
      <!-- Keep current filters sticky across submit -->
      <input type="hidden" name="month" id="fMonth" value="{{ selected_month or '' }}">
      <input type="hidden" name="card" value="{{ selected_card or '' }}">
      <input type="hidden" name="main" value="{{ selected_main or '' }}">
      <input type="hidden" name="cat" value="{{ selected_cat or '' }}">
      <!-- Keep active tab after redirect -->
      <input type="hidden" name="tab" value="review">

      <div>
        <label>Percentage (%)</label><br>
        <input type="number" name="percentage" id="fPct" step="0.01" min="0" max="100" placeholder="e.g., 25">
      </div>
      <div class="flex-1 min-260">
        <label>Note (optional)</label><br>
        <input type="text" name="note" id="fNote" placeholder="Your note...">
      </div>
      <div class="pill"><strong>Your share:</strong> <span id="pShare">$0.00</span></div>
      <div>
        <button class="btn secondary" type="submit">Apply to BigQuery</button>
        <button type="button" class="btn" id="clearPanel">Clear</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Tabs: accessible roving tabindex and panel visibility
(function(){
  const tabs = Array.from(document.querySelectorAll('.tabs .tab'));
  const panels = {
    filters: document.getElementById('tab-filters'),
    transactions: document.getElementById('tab-transactions'),
    review: document.getElementById('tab-review')
  };

  function show(name){
    tabs.forEach(t => {
      const isActive = t.dataset.tab === name;
      t.classList.toggle('active', isActive);
      t.setAttribute('aria-selected', isActive ? 'true' : 'false');
      t.setAttribute('tabindex', isActive ? '0' : '-1');
    });
    Object.entries(panels).forEach(([k, el]) => {
      el.classList.toggle('hidden', k !== name);
    });
  }

  // Default tab logic
  const serverTab = "{{ tab or '' }}";
  if (serverTab && panels[serverTab]) {
    show(serverTab);
  } else if ({% if review_rows and review_rows|length > 0 %}true{% else %}false{% endif %}) {
    show('transactions');
  } else {
    show('filters');
  }

  // Click and keyboard
  tabs.forEach(t => t.addEventListener('click', () => show(t.dataset.tab)));
  document.querySelector('.tabs').addEventListener('keydown', e => {
    const idx = tabs.findIndex(t => t.classList.contains('active'));
    if (e.key === 'ArrowRight') {
      e.preventDefault();
      const next = tabs[(idx + 1) % tabs.length];
      next.focus(); show(next.dataset.tab);
    } else if (e.key === 'ArrowLeft') {
      e.preventDefault();
      const prev = tabs[(idx - 1 + tabs.length) % tabs.length];
      prev.focus(); show(prev.dataset.tab);
    }
  });
})();
</script>

<script>
// Helper: format currency
const fmt2 = new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

// Elements
const table = document.getElementById('reviewTable');
const panelHint = document.getElementById('panelHint');
const panelContent = document.getElementById('panelContent');

const pMonth = document.getElementById('pMonth');
const pCard  = document.getElementById('pCard');
const pMain  = document.getElementById('pMain');
const pCat   = document.getElementById('pCat');
const pDesc  = document.getElementById('pDesc');
const pAmount= document.getElementById('pAmount');
const pComment = document.getElementById('pComment');
const pShare = document.getElementById('pShare');

const fRowhash = document.getElementById('fRowhash');
const fPct     = document.getElementById('fPct');
const fNote    = document.getElementById('fNote');
const clearBtn = document.getElementById('clearPanel');
const reviewForm = document.getElementById('reviewForm');

function selectRow(tr) {
  const data = tr.dataset;
  const origAmt = Number(data.amount || 0);
  pMonth.textContent = data.month || '';
  pCard.textContent  = data.card || '';
  pMain.textContent  = data.main || '';
  pCat.textContent   = data.cat || '';
  pDesc.textContent  = data.desc || '';
  pAmount.textContent= '$' + fmt2.format(origAmt);
  pComment.textContent = data.comment || '';

  fRowhash.value = data.rowhash || '';
  fPct.value = '';
  fNote.value = '';
  pShare.textContent = '$' + fmt2.format(0);

  panelHint.classList.add('hidden');
  panelContent.classList.remove('hidden');

  // Switch to Review tab automatically
  const reviewTab = document.querySelector('.tab[data-tab="review"]');
  reviewTab && reviewTab.click();
}

function computeShare() {
  const amtText = pAmount.textContent.replace(/[^0-9.\-]/g, '') || '0';
  const origAmt = Number(amtText);
  const pct = Number(fPct.value || 0);
  const share = origAmt * (pct / 100);
  pShare.textContent = '$' + fmt2.format(share);
}

if (table) {
  table.addEventListener('click', (e) => {
    const tr = e.target.closest('tr.selectable');
    if (tr) {
      [...table.tBodies[0].rows].forEach(r => r.classList.remove('selected'));
      tr.classList.add('selected');
      selectRow(tr);
    }
  });
}

fPct && fPct.addEventListener('input', computeShare);

reviewForm && reviewForm.addEventListener('submit', (e) => {
  const pct = Number(fPct.value || 0);
  const shareText = pShare.textContent || '$0.00';
  if (isNaN(pct) || pct <= 0 || pct > 100) {
    e.preventDefault();
    alert('Please enter a valid percentage between 0 and 100.');
    return;
  }
  const ok = confirm(`Apply this review?\n\nPercentage: ${pct.toFixed(2)}%\nYour share: ${shareText}\n\nThis will write to BigQuery.`);
  if (!ok) { e.preventDefault(); return; }
  const btn = reviewForm.querySelector('button[type="submit"]');
  if (btn) { btn.disabled = true; btn.textContent = 'Applying...'; }
});

clearBtn && clearBtn.addEventListener('click', () => {
  panelContent.classList.add('hidden');
  panelHint.classList.remove('hidden');
  if (table) [...table.tBodies[0].rows].forEach(r => r.classList.remove('selected'));
  const txTab = document.querySelector('.tab[data-tab="transactions"]');
  txTab && txTab.click();
});
</script>
{% endblock %}
