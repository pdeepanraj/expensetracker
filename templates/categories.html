{% extends "base.html" %}
{% block title %}Categories{% endblock %}

{% block content %}
<div class="card">
  <h3>Category Tester</h3>

  {% if message %}
    <p class="muted" style="color: {{ 'green' if message_type=='ok' else 'crimson' }};">{{ message }}</p>
  {% endif %}

  <form method="get" action="{{ url_for('categories_get') }}" class="inline" style="gap:12px;">
    <label for="desc">Description</label>
    <input id="desc" name="desc" type="text" value="{{ description }}" style="min-width:420px;" placeholder="Paste a transaction description">
    <button class="btn secondary" type="submit">Check</button>
  </form>

  {% if description %}
    <p class="muted">Result: MainCategory = <b>{{ result_main }}</b>, Category = <b>{{ result_cat }}</b></p>
  {% endif %}

  {% if result_cat == 'Other' or result_cat == '' %}
  <hr>
  <h4>Add New Category</h4>
  <p class="muted">Adds keywords to BigQuery table: {{ project if project else 'deepanexpense' }}.{{ dataset if dataset else 'expense_analytics' }}.category_config, then reclassifies matching “Other” rows.</p>
  <form method="post" action="{{ url_for('categories_add_post') }}" class="inline" style="gap:12px; align-items:flex-end;">
    <input type="hidden" name="desc" value="{{ description }}">
    <div>
      <label for="main">Main</label><br>
      <select id="main" name="main">
        {% for m in mains %}
          <option value="{{ m }}" {% if m == result_main %}selected{% endif %}>{{ m }}</option>
        {% endfor %}
        <option value="Misc">Misc</option>
      </select>
    </div>
    <div>
      <label for="category">Category</label><br>
      <input id="category" name="category" type="text" placeholder="e.g., Local Cafe">
    </div>
    <div style="min-width:420px;">
      <label for="keywords">Keywords (comma separated)</label><br>
      <input id="keywords" name="keywords" type="text" placeholder="e.g., cafe, local cafe, lcafe">
    </div>
    <button class="btn" type="submit">Add & Reclassify</button>
  </form>
  {% endif %}
</div>

<hr>
<h4>Reclassify ‘Other’ from Monthly Summary</h4>
<p class="muted">Source: {{ project if project else 'deepanexpense' }}.{{ dataset if dataset else 'expense_analytics' }}.all_positive_monthly</p>

<div class="table-scroll">
  <table>
    <thead>
      <tr>
        <th>Month</th>
        <th>Card</th>
        <th>Description</th>
        <th>Amount</th>
        <th>Set Main/Category</th>
      </tr>
    </thead>
    <tbody>
      {% for r in other_rows %}
      <tr>
        <td>{{ r.Month }}</td>
        <td>{{ r.CardName }}</td>
        <td>{{ r.Description }}</td>
        <td>{{ r.Amount|currency }}</td>
        <td>
          <form method="post" action="{{ url_for('categories_reclassify_monthly') }}" class="inline reclass-form" style="gap:8px;">
            <input type="hidden" name="month" value="{{ r.Month }}">
            <input type="hidden" name="card" value="{{ r.CardName }}">
            <input type="hidden" name="desc" value="{{ r.Description }}">

            <!-- Main dropdown -->
            <select name="main" class="main-select">
              {% for m in mains %}
                <option value="{{ m }}">{{ m }}</option>
              {% endfor %}
            </select>

            <!-- Category dropdown; populated based on Main -->
            <select name="category" class="category-select"></select>

            <button class="btn secondary" type="submit">Update</button>
          </form>
        </td>
      </tr>
      {% endfor %}
      {% if other_rows|length == 0 %}
      <tr>
        <td colspan="5" class="muted">No rows currently classified as “Other”.</td>
      </tr>
      {% endif %}
    </tbody>
  </table>
</div>
{% endblock %}

{% block scripts %}
<script>
(function(){
  // categories_by_main is provided by app.py: { "MainA": ["Cat1","Cat2"], ... }
  const byMain = {{ (categories_by_main or {})|tojson }};

  function populateCategorySelect(mainSel, catSel) {
    const main = mainSel.value;
    const cats = byMain[main] || [];
    // Remember current selection if possible
    const current = catSel.value;
    // Clear
    catSel.innerHTML = "";
    // Fill
    cats.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      catSel.appendChild(opt);
    });
    // Restore selection or pick first
    if (current && cats.includes(current)) {
      catSel.value = current;
    } else if (cats.length > 0) {
      catSel.value = cats[0];
    }
    // Disable if no categories
    catSel.disabled = cats.length === 0;
  }

  // Initialize all reclass forms
  document.querySelectorAll("form.reclass-form").forEach(form => {
    const mainSel = form.querySelector(".main-select");
    const catSel  = form.querySelector(".category-select");
    if (mainSel && catSel) {
      populateCategorySelect(mainSel, catSel);
      mainSel.addEventListener("change", () => populateCategorySelect(mainSel, catSel));
    }
  });
})();
</script>
{% endblock %}
