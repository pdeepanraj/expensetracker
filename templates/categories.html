{% extends "base.html" %}
{% block title %}Categories{% endblock %}

{% block head %}
<style>
  /* Top tab bar */
  .tabs {
    display: flex; gap: 8px; padding: 8px; background: #0b5cff; border-radius: 10px;
    color: #fff; align-items: center;
  }
  .tab {
    display: inline-flex; align-items: center; gap: 8px;
    padding: 10px 14px; border-radius: 8px; cursor: pointer; user-select: none;
    background: rgba(255,255,255,.08);
  }
  .tab.active { background: #fff; color: #0b5cff; font-weight: 600; }
  .tabs-spacer { flex: 1; }

  /* Section cards inside the page */
  .section { background: var(--panel); border: 1px solid var(--border); border-radius: 10px; padding: 16px; margin-top: 12px; }
  .section h3 { margin: 0 0 8px 0; }
  .row { display: grid; gap: 12px; }
  .grid-2 { grid-template-columns: 1fr 1fr; }
  .grid-3 { grid-template-columns: repeat(3, 1fr); }
  .muted { color: var(--muted); }

  /* Compact form controls */
  .form-row { display: flex; flex-wrap: wrap; align-items: flex-end; gap: 12px; }
  .form-field { display:flex; flex-direction: column; gap:6px; min-width: 220px; }
  .form-field input[type="text"], .form-field select, .form-field textarea {
    padding: 8px 10px; border-radius: 8px; border: 1px solid var(--border); background: #fff;
  }
  .hint { font-size: 12px; color: var(--muted); }

  /* Sticky table */
  .table-wrap { margin-top: 10px; border: 1px solid var(--border); border-radius: 10px; overflow: hidden; }
  .table-scroll { max-height: 58vh; overflow: auto; }
  table { width: 100%; border-collapse: collapse; }
  thead th { position: sticky; top: 0; background: #f3f4f6; border-bottom: 1px solid var(--border); padding: 10px; text-align: left; z-index: 1; }
  tbody td { padding: 10px; border-bottom: 1px solid var(--border); }
  tbody tr:hover { background: #fafafa; }

  /* Pills for results */
  .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; border: 1px solid var(--border); }
  .pill.ok { background: #ecfdf5; color: #065f46; border-color: #a7f3d0; }
  .pill.warn { background: #fff7ed; color: #9a3412; border-color: #fed7aa; }

  @media (max-width: 980px) {
    .grid-2, .grid-3 { grid-template-columns: 1fr; }
    .form-field { min-width: 180px; }
  }
</style>
{% endblock %}

{% block content %}

<!-- Tab bar -->
<div class="tabs">
  <div class="tab active" data-tab="tester">Source Database</div>
  <div class="tab" data-tab="add">Destination Database</div>
  <div class="tab" data-tab="reclass">Recovery</div>
  <div class="tabs-spacer"></div>
  <div class="muted">Configuration</div>
</div>

<!-- Tester section -->
<div class="section" id="tab-tester">
  <h3>Category Tester</h3>
  {% if message %}
    <p class="muted" style="color: {{ 'green' if message_type=='ok' else 'crimson' }};">{{ message }}</p>
  {% endif %}
  <form method="get" action="{{ url_for('categories_get') }}" class="form-row" style="margin-top:8px;">
    <div class="form-field" style="flex:1; min-width:360px;">
      <label for="desc">Description</label>
      <input id="desc" name="desc" type="text" value="{{ description }}" placeholder="Paste a transaction description">
      <div class="hint">Try a real Description from your data to see how it classifies.</div>
    </div>
    <div>
      <button class="btn secondary" type="submit">Check</button>
    </div>
  </form>

  {% if description %}
    <div style="margin-top:10px;">
      <span class="muted">Result:</span>
      <span class="pill {{ 'ok' if result_cat!='Other' else 'warn' }}">Main = {{ result_main or '—' }}</span>
      <span class="pill {{ 'ok' if result_cat!='Other' else 'warn' }}">Category = {{ result_cat or '—' }}</span>
    </div>
  {% endif %}
</div>

<!-- Add Category section -->
<div class="section" id="tab-add" style="display:none;">
  <h3>Add New Category</h3>
  <p class="muted">Adds keywords to BigQuery: {{ project if project else 'deepanexpense' }}.{{ dataset if dataset else 'expense_analytics' }}.category_config and reclassifies matching “Other” rows.</p>

  <form method="post" action="{{ url_for('categories_add_post') }}" class="form-row" style="margin-top:8px;">
    <input type="hidden" name="desc" value="{{ description }}">
    <div class="form-field">
      <label for="main">Main</label>
      <select id="main" name="main">
        {% for m in mains %}
          <option value="{{ m }}" {% if m == result_main %}selected{% endif %}>{{ m }}</option>
        {% endfor %}
        <option value="Misc">Misc</option>
      </select>
    </div>
    <div class="form-field">
      <label for="category">Category</label>
      <input id="category" name="category" type="text" placeholder="e.g., Local Cafe">
    </div>
    <div class="form-field" style="flex:1; min-width:360px;">
      <label for="keywords">Keywords (comma separated)</label>
      <input id="keywords" name="keywords" type="text" placeholder="e.g., cafe, local cafe, lcafe, kohl's">
      <div class="hint">You can include punctuation. We’ll handle regex escaping safely.</div>
    </div>
    <div>
      <button class="btn secondary" type="submit">Add & Reclassify</button>
    </div>
  </form>
</div>

<!-- Reclassify Other section -->
<div class="section" id="tab-reclass" style="display:none;">
  <h3>Reclassify “Other”</h3>
  <p class="muted">Source: {{ project if project else 'deepanexpense' }}.{{ dataset if dataset else 'expense_analytics' }}.all_positive_monthly</p>

  <div class="table-wrap">
    <div class="table-scroll">
      <table>
        <thead>
          <tr>
            <th style="width:120px;">Month</th>
            <th style="width:160px;">Card</th>
            <th>Description</th>
            <th style="width:120px;">Amount</th>
            <th style="width:360px;">Set Main/Category</th>
          </tr>
        </thead>
        <tbody>
          {% for r in other_rows %}
          <tr>
            <td>{{ r.Month }}</td>
            <td>{{ r.CardName }}</td>
            <td>{{ r.Description }}</td>
            <td>{{ r.Amount|currency }}</td>
            <td>
              <form method="post" action="{{ url_for('categories_reclassify_monthly') }}" class="inline reclass-form" style="gap:8px; flex-wrap:nowrap;">
                <input type="hidden" name="month" value="{{ r.Month }}">
                <input type="hidden" name="card" value="{{ r.CardName }}">
                <input type="hidden" name="desc" value="{{ r.Description }}">

                <select name="main" class="main-select" style="min-width:160px;">
                  {% for m in mains %}
                    <option value="{{ m }}">{{ m }}</option>
                  {% endfor %}
                </select>

                <select name="category" class="category-select" style="min-width:180px;"></select>

                <button class="btn" type="submit">Update</button>
              </form>
            </td>
          </tr>
          {% endfor %}
          {% if other_rows|length == 0 %}
          <tr>
            <td colspan="5" class="muted">No rows currently classified as “Other”.</td>
          </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
(function(){
  // Tab switching
  const tabs = document.querySelectorAll('.tab');
  const panels = {
    tester: document.getElementById('tab-tester'),
    add: document.getElementById('tab-add'),
    reclass: document.getElementById('tab-reclass'),
  };
  function activate(name){
    tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === name));
    Object.entries(panels).forEach(([k, el]) => el.style.display = (k === name ? '' : 'none'));
  }
  tabs.forEach(t => t.addEventListener('click', () => activate(t.dataset.tab)));
  // Choose initial tab based on context
  {% if description and (result_cat == 'Other' or result_cat == '') %}
    activate('add');
  {% else %}
    activate('tester');
  {% endif %}

  // Categories by Main (provided by app.py)
  const byMain = {{ (categories_by_main or {})|tojson }};

  function populateCategorySelect(mainSel, catSel) {
    const main = mainSel.value;
    const cats = byMain[main] || [];
    const current = catSel.value;
    catSel.innerHTML = "";
    cats.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c; opt.textContent = c;
      catSel.appendChild(opt);
    });
    if (current && cats.includes(current)) catSel.value = current;
    else if (cats.length) catSel.value = cats[0];
    catSel.disabled = cats.length === 0;
  }

  document.querySelectorAll("form.reclass-form").forEach(form => {
    const mainSel = form.querySelector(".main-select");
    const catSel  = form.querySelector(".category-select");
    if (mainSel && catSel) {
      populateCategorySelect(mainSel, catSel);
      mainSel.addEventListener("change", () => populateCategorySelect(mainSel, catSel));
    }
  });
})();
</script>
{% endblock %}
