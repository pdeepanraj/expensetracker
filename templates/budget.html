{% extends "base.html" %}
{% block title %}Budget & Income{% endblock %}
{% block head %}
<style>
.section { background: var(--panel); border:1px solid var(--border); border-radius:10px; padding:16px; margin-top:12px; }
.inline { display:flex; flex-wrap:wrap; gap:12px; align-items:flex-end; }
.grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
@media (max-width:980px){ .grid-2 { grid-template-columns:1fr; } }
.table-scroll { max-height:50vh; overflow:auto; border:1px solid var(--border); border-radius:10px; }
.pill { display:inline-block; padding:8px 12px; border-radius:999px; border:1px solid var(--border); background:#fff; }
.status-ok { background:#ecfdf5; border-color:#a7f3d0; color:#065f46; }
.status-bad { background:#fee2e2; border-color:#fecaca; color:#991b1b; }
.muted { color: var(--muted); }
.small-table { border:1px solid var(--border); border-radius:10px; overflow:auto; }
.small-table table { width:100%; border-collapse:collapse; }
.small-table th, .small-table td { padding:8px 10px; border-bottom:1px solid var(--border); text-align:left; }
.small-table thead th { background:#f3f4f6; position:sticky; top:0; z-index:1; }
.summary-grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:12px; }
@media (max-width:980px){ .summary-grid { grid-template-columns:1fr; } }
</style>
{% endblock %}

{% block content %}

<!-- Monthly Comparison first -->
<div class="section">
  <h3>Monthly Comparison{% if selected_month %} ({{ selected_month }}){% endif %}</h3>
  <div class="pill {% if status == 'Within limit' %}status-ok{% else %}status-bad{% endif %}">
    <strong>Status:</strong> {{ status }}
  </div>
  <div class="pill" style="margin-left:8px;"><strong>Cards Spend:</strong> {{ (cards_total or 0)|currency }}</div>
  <div class="pill" style="margin-left:8px;"><strong>Manual Spend:</strong> {{ (manual_total or 0)|currency }}</div>
  <div class="pill" style="margin-left:8px;"><strong>Total Income:</strong> {{ (income_total or 0)|currency }}</div>

  <!-- Compact grouped year summaries -->
  <div class="summary-grid">
    <div class="small-table">
      <table>
        <thead><tr><th>Manual Spend (Year)</th><th>Total</th></tr></thead>
        <tbody>
          {% for r in manual_year_summary %}
            <tr><td>{{ r.Year }}</td><td>{{ (r.Amount or 0)|currency }}</td></tr>
          {% endfor %}
          {% if manual_year_summary|length == 0 %}
            <tr><td colspan="2" class="muted">No manual spend summary.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
    <div class="small-table">
      <table>
        <thead><tr><th>Income (Year)</th><th>Total</th></tr></thead>
        <tbody>
          {% for r in income_year_summary %}
            <tr><td>{{ r.Year }}</td><td>{{ (r.Amount or 0)|currency }}</td></tr>
          {% endfor %}
          {% if income_year_summary|length == 0 %}
            <tr><td colspan="2" class="muted">No income summary.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Month filter -->
<div class="section">
  <h3>Select Month</h3>
  <form method="get" action="{{ url_for('budget_get') }}" class="inline">
    <div>
      <label>Month</label><br>
      <select name="month">
        <option value="">All</option>
        {% for m in months %}
          <option value="{{ m }}" {% if selected_month == m %}selected{% endif %}>{{ m }}</option>
        {% endfor %}
      </select>
    </div>
    <div><button class="btn secondary" type="submit">View</button></div>
  </form>
</div>

<!-- Card MainCategory totals (selected month) -->
<div class="section">
  <h3>MainCategory totals{% if selected_month %} ({{ selected_month }}){% endif %}</h3>
  <div class="table-scroll">
    <table>
      <thead><tr><th>MainCategory</th><th>Total Amount</th></tr></thead>
      <tbody>
        {% for r in main_totals %}
          <tr><td>{{ r.MainCategory }}</td><td>{{ (r.Amount or 0)|currency }}</td></tr>
        {% endfor %}
        {% if main_totals|length == 0 %}
          <tr><td colspan="2" class="muted">No card data for this view.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<div class="grid-2">
  <!-- Manual spend: add form + grouped tables -->
  <div class="section">
    <h3>Add Manual Spend</h3>
    <form method="post" action="{{ url_for('budget_spend_add') }}" class="inline">
      <input type="hidden" name="month" value="{{ selected_month }}">
      <div style="min-width:200px;">
        <label>Category (existing)</label><br>
        <select name="category">
          <option value="">-- Select --</option>
          {% for c in manual_categories %}
            <option value="{{ c }}">{{ c }}</option>
          {% endfor %}
        </select>
      </div>
      <div style="min-width:200px;">
        <label>Or new category</label><br>
        <input type="text" name="category_new" placeholder="Kids Class, Loan, Cash...">
      </div>
      <div style="flex:1; min-width:240px;">
        <label>Description</label><br>
        <input type="text" name="description" placeholder="Detail..." required>
      </div>
      <div style="min-width:140px;">
        <label>Amount</label><br>
        <input type="number" step="0.01" name="amount" required>
      </div>
      <div style="flex:1; min-width:240px;">
        <label>Note</label><br>
        <input type="text" name="note" placeholder="Optional">
      </div>
      <button class="btn secondary" type="submit">Add Spend</button>
    </form>

    <!-- Grouped by Category -->
    <h3 style="margin-top:14px;">Manual Spend by Category{% if selected_month %} ({{ selected_month }}){% endif %}</h3>
    <div class="table-scroll" style="margin-top:8px;">
      <table>
        <thead><tr><th>Category</th><th>Total Amount</th></tr></thead>
        <tbody>
          {% for r in manual_by_cat %}
            <tr>
              <td>{{ r.Category }}</td>
              <td>{{ (r.Amount or 0)|currency }}</td>
            </tr>
          {% endfor %}
          {% if manual_by_cat|length == 0 %}
            <tr><td colspan="2" class="muted">No manual spend for this view.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    <!-- Grouped by Year -->
    <h3 style="margin-top:14px;">Manual Spend by Year{% if selected_month %} (filtered){% endif %}</h3>
    <div class="table-scroll" style="margin-top:8px;">
      <table>
        <thead><tr><th>Year</th><th>Total Amount</th></tr></thead>
        <tbody>
          {% for r in manual_by_year %}
            <tr>
              <td>{{ r.Year }}</td>
              <td>{{ (r.Amount or 0)|currency }}</td>
            </tr>
          {% endfor %}
          {% if manual_by_year|length == 0 %}
            <tr><td colspan="2" class="muted">No manual spend for this view.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Income: add form + grouped tables -->
  <div class="section">
    <h3>Add Income</h3>
    <form method="post" action="{{ url_for('budget_income_add') }}" class="inline">
      <input type="hidden" name="month" value="{{ selected_month }}">
      <div style="min-width:200px;">
        <label>Source (existing)</label><br>
        <select name="source">
          <option value="">-- Select --</option>
          {% for s in income_sources %}
            <option value="{{ s }}">{{ s }}</option>
          {% endfor %}
        </select>
      </div>
      <div style="min-width:200px;">
        <label>Or new source</label><br>
        <input type="text" name="source_new" placeholder="Salary, Bonus, Other...">
      </div>
      <div style="min-width:140px;">
        <label>Amount</label><br>
        <input type="number" step="0.01" name="amount" required>
      </div>
      <div style="flex:1; min-width:240px;">
        <label>Note</label><br>
        <input type="text" name="note" placeholder="Optional">
      </div>
      <button class="btn secondary" type="submit">Add Income</button>
    </form>

    <!-- Grouped by Source -->
    <h3 style="margin-top:14px;">Income by Source{% if selected_month %} ({{ selected_month }}){% endif %}</h3>
    <div class="table-scroll" style="margin-top:8px;">
      <table>
        <thead><tr><th>Source</th><th>Total Amount</th></tr></thead>
        <tbody>
          {% for r in income_by_source %}
            <tr>
              <td>{{ r.Source }}</td>
              <td>{{ (r.Amount or 0)|currency }}</td>
            </tr>
          {% endfor %}
          {% if income_by_source|length == 0 %}
            <tr><td colspan="2" class="muted">No income for this view.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    <!-- Grouped by Year -->
    <h3 style="margin-top:14px;">Income by Year{% if selected_month %} (filtered){% endif %}</h3>
    <div class="table-scroll" style="margin-top:8px;">
      <table>
        <thead><tr><th>Year</th><th>Total Amount</th></tr></thead>
        <tbody>
          {% for r in income_by_year %}
            <tr>
              <td>{{ r.Year }}</td>
              <td>{{ (r.Amount or 0)|currency }}</td>
            </tr>
          {% endfor %}
          {% if income_by_year|length == 0 %}
            <tr><td colspan="2" class="muted">No income for this view.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{% endblock %}
