{% extends "base.html" %}
{% block title %}Budget & Income{% endblock %}
{% block head %}
<style>
.section { background: var(--panel); border:1px solid var(--border); border-radius:10px; padding:16px; margin-top:12px; }
.inline { display:flex; flex-wrap:wrap; gap:12px; align-items:flex-end; }
.grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
@media (max-width:980px){ .grid-2 { grid-template-columns:1fr; } }
.table-scroll { max-height:50vh; overflow:auto; border:1px solid var(--border); border-radius:10px; }

.pill { display:inline-block; padding:8px 12px; border-radius:999px; border:1px solid var(--border); background:#fff; }
.status-ok { background:#ecfdf5; border-color:#a7f3d0; color:#065f46; }
.status-bad { background:#fee2e2; border-color:#fecaca; color:#991b1b; }
.muted { color: var(--muted); }

.badge-ok { display:inline-block; padding:4px 8px; border-radius:999px; background:#ecfdf5; color:#065f46; border:1px solid #a7f3d0; font-size:12px; }
.badge-bad { display:inline-block; padding:4px 8px; border-radius:999px; background:#fee2e2; color:#991b1b; border:1px solid #fecaca; font-size:12px; }
</style>
{% endblock %}

{% block content %}

<!-- 1) Select Month -->
<div class="section">
  <h3>Select Month</h3>
  <form method="get" action="{{ url_for('budget_get') }}" class="inline">
    <div>
      <label>Month</label><br>
      <select name="month">
        <option value="">All</option>
        {% for m in months %}
          <option value="{{ m }}" {% if selected_month == m %}selected{% endif %}>{{ m }}</option>
        {% endfor %}
      </select>
    </div>
    <div><button class="btn secondary" type="submit">View</button></div>
  </form>
</div>

<!-- 2) Monthly Comparison -->
<div class="section">
  <h3>Monthly Comparison{% if selected_month %} ({{ selected_month }}){% endif %}</h3>

  <!-- Status pill -->
  <div class="pill {% if status == 'Within limit' %}status-ok{% else %}status-bad{% endif %}">
    <strong>Status:</strong> {{ status }}
  </div>

  <!-- Totals -->
  <div class="pill" style="margin-left:8px;"><strong>Cards Spend:</strong> {{ (cards_total or 0)|currency }}</div>
  <div class="pill" style="margin-left:8px;"><strong>Manual Spend:</strong> {{ (manual_total or 0)|currency }}</div>
  <div class="pill" style="margin-left:8px;"><strong>Total Income:</strong> {{ (income_total or 0)|currency }}</div>

  <!-- New: Variance -->
  {% set variance = (income_total or 0) - ((cards_total or 0) + (manual_total or 0)) %}
  <div class="pill {% if variance >= 0 %}status-ok{% else %}status-bad{% endif %}" style="margin-left:8px;">
    <strong>Variance (Income − Spend):</strong> {{ variance|currency }}
  </div>
</div>

<!-- 3) Add Manual Spend & Add Income (side-by-side) -->
<div class="grid-2">
  <!-- Add Manual Spend + grouped by Category -->
  <div class="section">
    <h3>Add Manual Spend</h3>
    <form method="post" action="{{ url_for('budget_spend_add') }}" class="inline">
      <input type="hidden" name="month" value="{{ selected_month }}">
      <div style="min-width:200px;">
        <label>Category (existing)</label><br>
        <select name="category">
          <option value="">-- Select --</option>
          {% for c in manual_categories %}
            <option value="{{ c }}">{{ c }}</option>
          {% endfor %}
        </select>
      </div>
      <div style="min-width:200px;">
        <label>Or new category</label><br>
        <input type="text" name="category_new" placeholder="Kids Class, Loan, Cash...">
      </div>
      <div style="flex:1; min-width:240px;">
        <label>Description</label><br>
        <input type="text" name="description" placeholder="Detail..." required>
      </div>
      <div style="min-width:140px;">
        <label>Amount</label><br>
        <input type="number" step="0.01" name="amount" required>
      </div>
      <div style="flex:1; min-width:240px;">
        <label>Note</label><br>
        <input type="text" name="note" placeholder="Optional">
      </div>
      <button class="btn secondary" type="submit">Add Spend</button>
    </form>

    <!-- Grouped by Category -->
    <h3 style="margin-top:14px;">Manual Spend by Category{% if selected_month %} ({{ selected_month }}){% endif %}</h3>
    <div class="table-scroll" style="margin-top:8px;">
      <table>
        <thead><tr><th>Category</th><th>Total Amount</th></tr></thead>
        <tbody>
          {% for r in manual_by_cat %}
            <tr>
              <td>{{ r.Category }}</td>
              <td>{{ (r.Amount or 0)|currency }}</td>
            </tr>
          {% endfor %}
          {% if manual_by_cat|length == 0 %}
            <tr><td colspan="2" class="muted">No manual spend for this view.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Add Income + grouped by Source -->
  <div class="section">
    <h3>Add Income</h3>
    <form method="post" action="{{ url_for('budget_income_add') }}" class="inline">
      <input type="hidden" name="month" value="{{ selected_month }}">
      <div style="min-width:200px;">
        <label>Source (existing)</label><br>
        <select name="source">
          <option value="">-- Select --</option>
          {% for s in income_sources %}
            <option value="{{ s }}">{{ s }}</option>
          {% endfor %}
        </select>
      </div>
      <div style="min-width:200px;">
        <label>Or new source</label><br>
        <input type="text" name="source_new" placeholder="Salary, Bonus, Other...">
      </div>
      <div style="min-width:140px;">
        <label>Amount</label><br>
        <input type="number" step="0.01" name="amount" required>
      </div>
      <div style="flex:1; min-width:240px;">
        <label>Note</label><br>
        <input type="text" name="note" placeholder="Optional">
      </div>
      <button class="btn secondary" type="submit">Add Income</button>
    </form>

    <!-- Grouped by Source -->
    <h3 style="margin-top:14px;">Income by Source{% if selected_month %} ({{ selected_month }}){% endif %}</h3>
    <div class="table-scroll" style="margin-top:8px;">
      <table>
        <thead><tr><th>Source</th><th>Total Amount</th></tr></thead>
        <tbody>
          {% for r in income_by_source %}
            <tr>
              <td>{{ r.Source }}</td>
              <td>{{ (r.Amount or 0)|currency }}</td>
            </tr>
          {% endfor %}
          {% if income_by_source|length == 0 %}
            <tr><td colspan="2" class="muted">No income for this view.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- 4) All-Month Comparison table -->
<div class="section">
  <h3>All-Month Comparison</h3>
  <p class="muted" style="margin-bottom:8px;">Income vs Spend by Month. Variance = Income − (Cards + Manual).</p>
  <div class="table-scroll">
    <table>
      <thead>
        <tr>
          <th>Month</th>
          <th>Total Income</th>
          <th>Card Spend</th>
          <th>Manual Spend</th>
          <th>Variance</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        {% for r in monthly_comparison_rows %}
          {% set var = (r.Income or 0) - ((r.Cards or 0) + (r.Manual or 0)) %}
          <tr>
            <td>{{ r.Month }}</td>
            <td>{{ (r.Income or 0)|currency }}</td>
            <td>{{ (r.Cards or 0)|currency }}</td>
            <td>{{ (r.Manual or 0)|currency }}</td>
            <td>{{ var|currency }}</td>
            <td>
              {% if var >= 0 %}
                <span class="badge-ok">Within limit</span>
              {% else %}
                <span class="badge-bad">Exceeded</span>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
        {% if monthly_comparison_rows|length == 0 %}
          <tr><td colspan="6" class="muted">No data yet.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

{% endblock %}
