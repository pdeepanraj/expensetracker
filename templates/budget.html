{% extends "base.html" %}
{% block title %}Budget & Income{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/budget.css') }}">
{% endblock %}

{% block content %}

<!-- 1) Select Month -->
<div class="section">
  <h3>Select Month</h3>
  <form method="get" action="{{ url_for('budget_get') }}" class="inline inline-end">
    <div>
      <label>Month</label><br>
      <select name="month">
        <option value="">All</option>
        {% for m in months %}
          <option value="{{ m }}" {% if selected_month == m %}selected{% endif %}>{{ m }}</option>
        {% endfor %}
      </select>
    </div>
    <div><button class="btn secondary" type="submit">View</button></div>
  </form>
</div>

<!-- 2) Monthly Comparison -->
<div class="section">
  <h3>Monthly Comparison{% if selected_month %} ({{ selected_month }}){% endif %}</h3>

  <!-- Status pill -->
  <div class="pill {% if status == 'Within limit' %}status-ok{% else %}status-bad{% endif %}">
    <strong>Status:</strong> {{ status }}
  </div>

  <!-- Totals -->
  <div class="pill ml-8"><strong>Cards Spend:</strong> {{ (cards_total or 0)|currency }}</div>
  <div class="pill ml-8"><strong>Manual Spend:</strong> {{ (manual_total or 0)|currency }}</div>
  <div class="pill ml-8"><strong>Total Income:</strong> {{ (income_total or 0)|currency }}</div>

  <!-- New: Variance -->
  {% set variance = (income_total or 0) - ((cards_total or 0) + (manual_total or 0)) %}
  <div class="pill {% if variance >= 0 %}status-ok{% else %}status-bad{% endif %} ml-8">
    <strong>Variance (Income − Spend):</strong> {{ variance|currency }}
  </div>
</div>

<!-- 3) Add Manual Spend & Add Income (side-by-side) -->
<div class="grid-2">
  <!-- Add Manual Spend + grouped by Category -->
  <div class="section">
    <h3>Add Manual Spend</h3>
    <form method="post" action="{{ url_for('budget_spend_add') }}" class="inline inline-end">
      <input type="hidden" name="month" value="{{ selected_month }}">
      <div class="min-200">
        <label>Category (existing)</label><br>
        <select name="category">
          <option value="">-- Select --</option>
          {% for c in manual_categories %}
            <option value="{{ c }}">{{ c }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="min-200">
        <label>Or new category</label><br>
        <input type="text" name="category_new" placeholder="Kids Class, Loan, Cash...">
      </div>
      <div class="flex-1 min-240">
        <label>Description</label><br>
        <input type="text" name="description" placeholder="Detail..." required>
      </div>
      <div class="min-140">
        <label>Amount</label><br>
        <input type="number" step="0.01" name="amount" required>
      </div>
      <div class="flex-1 min-240">
        <label>Note</label><br>
        <input type="text" name="note" placeholder="Optional">
      </div>
      <button class="btn secondary" type="submit">Add Spend</button>
    </form>

    <!-- Grouped by Category -->
    <h3 class="mt-14">Manual Spend by Category{% if selected_month %} ({{ selected_month }}){% endif %}</h3>
    <div class="table-scroll mt-8">
      <table>
        <thead><tr><th>Category</th><th>Total Amount</th></tr></thead>
        <tbody>
          {% for r in manual_by_cat %}
            <tr>
              <td>{{ r.Category }}</td>
              <td>{{ (r.Amount or 0)|currency }}</td>
            </tr>
          {% endfor %}
          {% if manual_by_cat|length == 0 %}
            <tr><td colspan="2" class="muted">No manual spend for this view.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Add Income + grouped by Source -->
  <div class="section">
    <h3>Add Income</h3>
    <form method="post" action="{{ url_for('budget_income_add') }}" class="inline inline-end">
      <input type="hidden" name="month" value="{{ selected_month }}">
      <div class="min-200">
        <label>Source (existing)</label><br>
        <select name="source">
          <option value="">-- Select --</option>
          {% for s in income_sources %}
            <option value="{{ s }}">{{ s }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="min-200">
        <label>Or new source</label><br>
        <input type="text" name="source_new" placeholder="Salary, Bonus, Other...">
      </div>
      <div class="min-140">
        <label>Amount</label><br>
        <input type="number" step="0.01" name="amount" required>
      </div>
      <div class="flex-1 min-240">
        <label>Note</label><br>
        <input type="text" name="note" placeholder="Optional">
      </div>
      <button class="btn secondary" type="submit">Add Income</button>
    </form>

    <!-- Grouped by Source -->
    <h3 class="mt-14">Income by Source{% if selected_month %} ({{ selected_month }}){% endif %}</h3>
    <div class="table-scroll mt-8">
      <table>
        <thead><tr><th>Source</th><th>Total Amount</th></tr></thead>
        <tbody>
          {% for r in income_by_source %}
            <tr>
              <td>{{ r.Source }}</td>
              <td>{{ (r.Amount or 0)|currency }}</td>
            </tr>
          {% endfor %}
          {% if income_by_source|length == 0 %}
            <tr><td colspan="2" class="muted">No income for this view.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- 4) All-Month Comparison table -->
<div class="section">
  <h3>All-Month Comparison</h3>
  <p class="muted mb-8">Income vs Spend by Month. Variance = Income − (Cards + Manual).</p>
  <div class="table-scroll">
    <table>
      <thead>
        <tr>
          <th>Month</th>
          <th>Total Income</th>
          <th>Card Spend</th>
          <th>Manual Spend</th>
          <th>Variance</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        {% for r in monthly_comparison_rows %}
          {% set var = (r.Income or 0) - ((r.Cards or 0) + (r.Manual or 0)) %}
          <tr>
            <td>{{ r.Month }}</td>
            <td>{{ (r.Income or 0)|currency }}</td>
            <td>{{ (r.Cards or 0)|currency }}</td>
            <td>{{ (r.Manual or 0)|currency }}</td>
            <td>{{ var|currency }}</td>
            <td>
              {% if var >= 0 %}
                <span class="badge-ok">Within limit</span>
              {% else %}
                <span class="badge-bad">Exceeded</span>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
        {% if monthly_comparison_rows|length == 0 %}
          <tr><td colspan="6" class="muted">No data yet.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

{% endblock %}
