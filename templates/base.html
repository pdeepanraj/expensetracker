<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>{% block title %}Expense Tracker{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Design tokens first, then components -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/variables.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">

  {% block head %}{% endblock %}
</head>
<body>
  <!-- Fixed Header -->
  <header class="app-header">
    <div class="app-brand">
      <button class="btn sidebar-toggle" type="button" aria-label="Toggle sidebar" onclick="toggleSidebar()">Menu</button>
      <span class="logo" aria-hidden="true"></span>
      <span>Expense Tracker</span>
    </div>
    <div class="app-actions">
      <button id="themeToggle" class="btn" type="button" title="Toggle theme">Theme</button>
      <button id="compactToggle" class="btn" type="button" title="Toggle compact mode">Compact</button>
    </div>
  </header>

  <!-- Fixed Sidebar -->
  <aside id="appSidebar" class="app-sidebar" aria-label="Primary">
    <div class="nav">
      <div class="nav-title">Main</div>
      <a href="{{ url_for('index') }}" class="{{ 'active' if request.endpoint=='index' else '' }}">Home</a>
      <a href="{{ url_for('dashboard_details') }}" class="{{ 'active' if request.endpoint in ['dashboard','dashboard_details','dashboard_manual','dashboard_income','aggregate'] else '' }}">Dashboard</a>
      <a href="{{ url_for('bills') }}" class="{{ 'active' if request.endpoint=='bills' else '' }}">Bills</a>
      <a href="{{ url_for('categories_get') }}" class="{{ 'active' if request.endpoint=='categories_get' else '' }}">Categories</a>
      <a href="{{ url_for('status') }}" class="{{ 'active' if request.endpoint=='status' else '' }}">Status</a>
      <a href="{{ url_for('budget_get') }}" class="{{ 'active' if request.endpoint=='budget_get' else '' }}">Budget & Income</a>
      <a href="{{ url_for('review_get') }}" class="{{ 'active' if request.endpoint=='review_get' else '' }}">Review</a>
    </div>
  </aside>

  <!-- Overlay for mobile sidebar -->
  <div id="appOverlay" class="app-overlay" onclick="toggleSidebar()" aria-hidden="true"></div>

  <!-- Scrollable Content -->
  <main class="app-content" role="main">
    {% block header_meta %}{% endblock %}
    {% block content %}{% endblock %}
  </main>

  <script>
    // Sidebar toggle (mobile)
    function toggleSidebar(){
      const el = document.getElementById('appSidebar');
      const ov = document.getElementById('appOverlay');
      const open = el.classList.toggle('open');
      document.body.style.overflow = open ? 'hidden' : '';
      if (ov) ov.style.display = open ? '' : 'none';
    }

    // Theme and Compact toggles with persistence + header scroll tint
    (function(){
      const html = document.documentElement;
      const themeKey = 'app-theme';
      const compactKey = 'app-compact';
      const btnTheme = document.getElementById('themeToggle');
      const btnCompact = document.getElementById('compactToggle');
      const savedTheme = localStorage.getItem(themeKey);
      const savedCompact = localStorage.getItem(compactKey);

      // Theme init (respect OS if no saved choice)
      if (!savedTheme) {
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (prefersDark) html.setAttribute('data-theme', 'dark');
      } else {
        html.setAttribute('data-theme', savedTheme);
      }

      function setTheme(next){
        if (next) {
          html.setAttribute('data-theme', next);
          localStorage.setItem(themeKey, next);
        } else {
          html.removeAttribute('data-theme');
          localStorage.removeItem(themeKey);
        }
        window.dispatchEvent(new CustomEvent('theme-changed', { detail: { theme: next }}));
      }

      // Compact init
      if (savedCompact === '1') {
        html.setAttribute('data-compact', '1');
      }

      function setCompact(on){
        if (on) {
          html.setAttribute('data-compact', '1');
          localStorage.setItem(compactKey, '1');
        } else {
          html.removeAttribute('data-compact');
          localStorage.removeItem(compactKey);
        }
        window.dispatchEvent(new CustomEvent('compact-changed', { detail: { compact: !!on }}));
      }

      if (btnTheme) {
        btnTheme.addEventListener('click', () => {
          const cur = html.getAttribute('data-theme');
          const next = (cur === 'dark') ? 'light' : 'dark';
          setTheme(next);
        });
      }
      if (btnCompact) {
        btnCompact.addEventListener('click', () => {
          const on = html.getAttribute('data-compact') === '1';
          setCompact(!on);
        });
      }

      // Scroll tint for header (works with page or content scroll)
      const header = document.querySelector('.app-header');
      const content = document.querySelector('.app-content');

      function onScroll(){
        if (!header) return;
        const scTop = (window.scrollY || 0) + (content ? content.scrollTop || 0 : 0);
        const scrolled = scTop > 8;
        header.classList.toggle('scrolled', !!scrolled);
      }
      window.addEventListener('scroll', onScroll, { passive: true });
      if (content) content.addEventListener('scroll', onScroll, { passive: true });
      onScroll();
    })();
  </script>

  {% block scripts %}{% endblock %}
</body>
</html>
