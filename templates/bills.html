{% extends "base.html" %}
{% block title %}Credit Card Bills{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/bills.css') }}">
{% endblock %}

{% block header_meta %}
{{ project }}.{{ dataset }}.credit_card_bills
{% endblock %}

{% block content %}
<div class="card card-plain mb-0">
  <h3 class="mb-6">Credit Card Bills</h3>
  <p class="muted">Track due dates, monthly amounts, and payments. Viewing: {{ bill_month }}</p>
</div>

<!-- Filters -->
<div class="card">
  <form method="get" action="{{ url_for('bills') }}" class="inline inline-end">
    <div>
      <label for="m">Month</label><br>
      <input type="month" id="m" name="m" value="{{ bill_month }}">
    </div>
    <label class="inline gap-6">
      <input type="checkbox" name="unpaid" value="1" {% if unpaid_only %}checked{% endif %}>
      Unpaid only
    </label>
    <div class="actions">
      <button class="btn secondary" type="submit">Go</button>
      {% if prev_month %}
        <a class="btn" href="{{ url_for('bills') }}?m={{ prev_month }}{% if unpaid_only %}&unpaid=1{% endif %}">« {{ prev_month }}</a>
      {% endif %}
      {% if next_month %}
        <a class="btn" href="{{ url_for('bills') }}?m={{ next_month }}{% if unpaid_only %}&unpaid=1{% endif %}">{{ next_month }} »</a>
      {% endif %}
    </div>
  </form>
</div>

<!-- Current Month Bills -->
<div class="card">
  <h3>Current Month Bills ({{ bill_month }})</h3>
  <p class="muted mb-8">
    Due status:
    <span class="due-status due-green" title="> 14 days"></span> green,
    <span class="due-status due-amber" title="7–14 days"></span> amber,
    <span class="due-status due-red" title="< 7 days"></span> red.
  </p>

  <div class="table-scroll">
    <table id="billsTable" data-month="{{ bill_month }}">
      <thead>
        <tr>
          <th class="w-100">Due</th>
          <th class="w-180">Card</th>
          <th class="w-100">DueDay</th>
          <th class="w-140">Amount</th>
          <th class="w-100">Paid</th>
          <th class="w-180">PaidAt</th>
          <th>Note</th>
          <th class="w-160">Action</th>
        </tr>
      </thead>
      <tbody>
        {% for b in bills %}
        <tr data-paid="{{ '1' if b.Paid else '0' }}">
          <td><span class="due-status"></span></td>
          <td>{{ b.CardName }}</td>
          <td>{{ b.DueDay }}</td>
          <td>{{ (b.Amount or 0)|currency }}</td>
          <td>{{ 'Yes' if b.Paid else 'No' }}</td>
          <td>{{ b.PaidAt or '' }}</td>
          <td>{{ b.Note or '' }}</td>
          <td>
            {% if not b.Paid %}
            <form method="post" action="{{ url_for('bills_mark_paid') }}" class="inline">
              <input type="hidden" name="row_id" value="{{ b.RowId }}">
              <input type="hidden" name="bill_month" value="{{ bill_month }}">
              <button class="btn" type="submit">Mark Paid</button>
            </form>
            {% else %}
            <span class="badge">Completed</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
        {% if not bills %}
        <tr><td colspan="8" class="muted">No bills saved for {{ bill_month }} yet.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<div class="grid-2">
  <!-- Summary -->
  <div class="card">
    <h3>Summary ({{ bill_month }})</h3>
    <div class="kpi">
      <div class="pill"><strong>Total:</strong> {{ (summary.TotalAmount or 0)|currency }}</div>
      <div class="pill ok"><strong>Paid:</strong> {{ summary.PaidCount|intgroup }}</div>
      <div class="pill warn"><strong>Unpaid:</strong> {{ summary.UnpaidCount|intgroup }}</div>
    </div>
    {% if cards|length == 0 %}
      <p class="muted mt-8">No cards found yet. Add your first card and due date below.</p>
    {% endif %}
  </div>

  <!-- Add New Card -->
  <div class="card">
    <h3>Add New Card</h3>
    <form method="post" action="{{ url_for('bills_add_card') }}" class="inline inline-end">
      <input type="hidden" name="view_month" value="{{ bill_month }}">
      <div class="flex-1 min-220">
        <label>Card Name</label><br>
        <input type="text" name="card" placeholder="e.g., AMEX Gold" required>
      </div>
      <div class="min-140">
        <label>Default Due Day</label><br>
        <input type="number" name="due_day" min="1" max="31" required>
      </div>
      <div class="flex-1 min-240">
        <label>Note</label><br>
        <input type="text" name="note" placeholder="Optional note...">
      </div>
      <div class="actions">
        <button class="btn secondary" type="submit">Add Card</button>
      </div>
    </form>

    {% if cards|length > 0 %}
      <p class="muted mt-8">Existing cards:</p>
      <div class="kpi">
        {% for c in cards %}
          <div class="pill">{{ c.CardName }} — Due Day: {{ c.DueDay }}</div>
        {% endfor %}
      </div>
    {% endif %}
  </div>
</div>

<!-- Add/Update monthly bill -->
<div class="card">
  <h3>Add or Update Bill ({{ bill_month }})</h3>
  <form method="post" action="{{ url_for('bills_add') }}" class="inline inline-end">
    <input type="hidden" name="bill_month" value="{{ bill_month }}">
    <div class="flex-1 min-220">
      <label>Card</label><br>
      <select name="card" required>
        <option value="">-- Select --</option>
        {% for c in cards %}
          <option value="{{ c.CardName }}">{{ c.CardName }}</option>
        {% endfor %}
      </select>
      {% if cards|length == 0 %}
      <p class="muted mt-6">Add a card first to use this form.</p>
      {% endif %}
    </div>
    <div class="min-160">
      <label>Amount</label><br>
      <input type="number" name="amount" step="0.01" min="0" placeholder="e.g., 350.00" required>
    </div>
    <div class="flex-1 min-240">
      <label>Note</label><br>
      <input type="text" name="note" placeholder="Optional note...">
    </div>
    <div class="actions">
      <button class="btn secondary" type="submit" {% if cards|length == 0 %}disabled{% endif %}>Save</button>
    </div>
  </form>
  <p class="muted mt-8">Due Day is taken from the card’s default (set above) when creating a month entry.</p>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Compute due-status colors per row relative to current date (only for current month view)
  (function() {
    const tbl = document.getElementById('billsTable');
    if (!tbl) return;

    const ym = tbl.dataset.month || '';
    const today = new Date();
    const nowKey = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2,'0')}`;
    const sameMonth = (ym === nowKey);

    const daysInMonth = (y, m) => new Date(y, m, 0).getDate();
    const parts = ym.split('-');
    if (parts.length !== 2) return;
    const y = Number(parts[0]), m = Number(parts[1]);
    const dim = daysInMonth(y, m);

    for (const row of tbl.tBodies[0].rows) {
      const paid = row.dataset.paid === '1';
      const statusEl = row.querySelector('.due-status');
      const dueDayCell = row.cells[2];
      if (!statusEl || !dueDayCell) continue;

      const dueDay = Number(dueDayCell.textContent.trim());
      if (!dueDay || dueDay < 1 || dueDay > dim) continue;

      if (!sameMonth) {
        statusEl.classList.add('due-green'); // default when viewing a past/future month
        continue;
      }

      const dueDate = new Date(y, m - 1, dueDay);
      const diffDays = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));

      if (paid) {
        statusEl.classList.add('due-green');
      } else if (diffDays < 0) {
        statusEl.classList.add('due-red');
      } else if (diffDays <= 7) {
        statusEl.classList.add('due-amber');
        row.classList.add('row-urgent'); // subtle highlight via CSS
      } else {
        statusEl.classList.add('due-green');
      }
    }
  })();
</script>
{% endblock %}
