{% extends "base.html" %}
{% block title %}Credit Card Bills{% endblock %}

{% block header_meta %}
{{ project }}.{{ dataset }}.credit_card_bills
{% endblock %}

{% block content %}
<div class="card" style="padding:16px; border:none; box-shadow:none; background:transparent; margin-bottom:8px;">
  <h3 style="margin:0 0 6px;">Credit Card Bills</h3>
  <p class="muted">Track due dates, monthly amounts, and payments. Viewing: {{ bill_month }}</p>
</div>

<!-- Month picker + Unpaid filter -->
<div class="card">
  <form method="get" action="{{ url_for('bills') }}" class="inline" style="flex-wrap:wrap; gap:12px; align-items:end;">
    <div>
      <label for="m">Month</label>
      <input type="month" id="m" name="m" value="{{ bill_month }}">
    </div>
    <label class="inline" style="gap:6px;">
      <input type="checkbox" name="unpaid" value="1" {% if unpaid_only %}checked{% endif %}>
      Unpaid only
    </label>
    <div class="actions">
      <button type="submit">Go</button>
      {% if prev_month %}
      <a class="btn secondary" href="{{ url_for('bills') }}?m={{ prev_month }}{% if unpaid_only %}&unpaid=1{% endif %}">« {{ prev_month }}</a>
      {% endif %}
      {% if next_month %}
      <a class="btn secondary" href="{{ url_for('bills') }}?m={{ next_month }}{% if unpaid_only %}&unpaid=1{% endif %}">{{ next_month }} »</a>
      {% endif %}
    </div>
  </form>
</div>

<div class="grid-2">
  <!-- Summary -->
  <div class="card">
    <h3>Summary ({{ bill_month }})</h3>
    <div class="kpi">
      <div class="pill"><strong>Total:</strong> {{ (summary.TotalAmount or 0)|currency }}</div>
      <div class="pill"><strong>Paid:</strong> {{ summary.PaidCount|intgroup }}</div>
      <div class="pill"><strong>Unpaid:</strong> {{ summary.UnpaidCount|intgroup }}</div>
    </div>
    {% if cards|length == 0 %}
      <p class="muted" style="margin-top:8px;">No cards found yet. Add your first card and due date below.</p>
    {% endif %}
  </div>

  <!-- Add New Card (master record with default Due Day) -->
  <div class="card">
    <h3>Add New Card</h3>
    <form method="post" action="{{ url_for('bills_add_card') }}" class="inline" style="flex-wrap:wrap; gap:12px;">
      <input type="hidden" name="view_month" value="{{ bill_month }}">
      <div style="min-width:200px; flex:1;">
        <label>Card Name</label>
        <input type="text" name="card" placeholder="e.g., AMEX Gold" required>
      </div>
      <div style="min-width:120px;">
        <label>Default Due Day</label>
        <input type="number" name="due_day" min="1" max="31" required>
      </div>
      <div style="min-width:220px; flex:1;">
        <label>Note</label>
        <input type="text" name="note" placeholder="Optional note...">
      </div>
      <div class="actions">
        <button type="submit">Add Card</button>
      </div>
    </form>
    {% if cards|length > 0 %}
      <p class="muted" style="margin-top:8px;">Existing cards:</p>
      <div class="kpi">
        {% for c in cards %}
          <div class="pill">{{ c.CardName }} — Due Day: {{ c.DueDay }}</div>
        {% endfor %}
      </div>
    {% endif %}
  </div>
</div>

<!-- Add/Update monthly bill (reuses card’s master Due Day) -->
<div class="card">
  <h3>Add or Update Bill ({{ bill_month }})</h3>
  <form method="post" action="{{ url_for('bills_add') }}" class="inline" style="flex-wrap:wrap; gap:12px;">
    <input type="hidden" name="bill_month" value="{{ bill_month }}">
    <div style="min-width:200px; flex:1;">
      <label>Card</label>
      <select name="card" required>
        <option value="">-- Select --</option>
        {% for c in cards %}
        <option value="{{ c.CardName }}">{{ c.CardName }}</option>
        {% endfor %}
      </select>
      {% if cards|length == 0 %}
      <p class="muted" style="margin:6px 0 0;">Add a card first to use this form.</p>
      {% endif %}
    </div>
    <div style="min-width:160px;">
      <label>Amount</label>
      <input type="number" name="amount" step="0.01" min="0" placeholder="e.g., 350.00" required>
    </div>
    <div style="min-width:220px; flex:1;">
      <label>Note</label>
      <input type="text" name="note" placeholder="Optional note...">
    </div>
    <div class="actions">
      <button type="submit" {% if cards|length == 0 %}disabled{% endif %}>Save</button>
    </div>
  </form>
  <p class="muted" style="margin-top:8px;">Due Day is taken from the card’s default (set above) when creating a month entry.</p>
</div>

<!-- Current month bills -->
<div class="card">
  <h3>Current Month Bills ({{ bill_month }})</h3>
  <div class="table-scroll">
    <table id="billsTable" data-month="{{ bill_month }}">
      <thead>
        <tr>
          <th>CardName</th>
          <th>DueDay</th>
          <th>Amount</th>
          <th>Paid</th>
          <th>PaidAt</th>
          <th>Note</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for b in bills %}
        <tr data-paid="{{ '1' if b.Paid else '0' }}">
          <td>{{ b.CardName }}</td>
          <td>{{ b.DueDay }}</td>
          <td>{{ (b.Amount or 0)|currency }}</td>
          <td>{{ 'Yes' if b.Paid else 'No' }}</td>
          <td>{{ b.PaidAt or '' }}</td>
          <td>{{ b.Note or '' }}</td>
          <td>
            {% if not b.Paid %}
            <form method="post" action="{{ url_for('bills_mark_paid') }}" class="inline">
              <input type="hidden" name="row_id" value="{{ b.RowId }}">
              <input type="hidden" name="bill_month" value="{{ bill_month }}">
              <button type="submit">Mark Paid</button>
            </form>
            {% else %}
            <span class="badge">Completed</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
        {% if not bills %}
        <tr><td colspan="7" class="muted">No bills saved for {{ bill_month }} yet.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Due soon highlight for unpaid rows within next 7 days of the real current date (only if viewing the current month)
  (function() {
    const tbl = document.getElementById('billsTable');
    if (!tbl) return;
    const ym = tbl.dataset.month || '';
    const today = new Date();
    const nowKey = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2,'0')}`;
    const sameMonth = (ym === nowKey);

    if (!sameMonth) return;

    const daysInMonth = (y, m) => new Date(y, m, 0).getDate();
    const [y, m] = ym.split('-').map(Number);
    const dim = daysInMonth(y, m);

    [...tbl.tBodies[0].rows].forEach(row => {
      const paid = row.dataset.paid === '1';
      if (paid) return;
      const dueDayCell = row.cells[1];
      if (!dueDayCell) return;
      const dueDay = Number(dueDayCell.textContent.trim());
      if (!dueDay || dueDay < 1 || dueDay > dim) return;
      const dueDate = new Date(y, m - 1, dueDay);
      const diffDays = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
      if (diffDays >= 0 && diffDays <= 7) {
        row.style.background = 'rgba(255, 200, 0, 0.15)';  // subtle highlight
      }
    });
  })();
</script>
{% endblock %}
