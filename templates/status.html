{% extends "base.html" %}
{% block title %}Status{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/status.css') }}">
{% endblock %}

{% block header_meta %}
{{ project }}.{{ dataset }}.{{ table }}
{% endblock %}

{% block content %}
<div class="card card-plain mb-8">
  <h3 class="mb-6">Status</h3>
  <p class="muted">Totals and recent activity</p>
</div>

<section class="content">
  <div class="grid-2">
    <!-- Entire total box -->
    <div class="card">
      <h3>Entire Total</h3>
      <div class="kpi">
        <div class="pill"><strong>Total Amount:</strong> {{ (total_amount_all or 0)|currency }}</div>
      </div>
      <p class="muted mt-8">Aggregated across all months, cards, and categories.</p>
      <div class="table-scroll mt-10 max-220">
        <table>
          <thead><tr><th>Year</th><th>Total Amount</th></tr></thead>
          <tbody>
            {% for y in year_totals %}
            <tr><td>{{ y.Year }}</td><td>{{ (y.Amount or 0)|currency }}</td></tr>
            {% endfor %}
            {% if year_totals|length == 0 %}
            <tr><td colspan="2" class="muted">No data.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Totals by MainCategory (entire dataset) -->
    <div class="card">
      <h3>Totals by MainCategory</h3>
      <p class="muted mb-8">Summed over the entire dataset.</p>
      <div class="table-scroll">
        <table>
          <thead>
            <tr>
              <th>MainCategory</th>
              <th>Total Amount</th>
            </tr>
          </thead>
          <tbody>
            {% for r in main_totals_all %}
            <tr>
              <td>{{ r.MainCategory }}</td>
              <td>{{ (r.Amount or 0)|currency }}</td>
            </tr>
            {% endfor %}
            {% if main_totals_all|length == 0 %}
            <tr><td colspan="2" class="muted">No data.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Sources coverage (cards + manual) -->
  <div class="card mt-16">
    <h3>Sources Coverage</h3>
    <p class="muted mb-8">Shows each credit card and Manual spend with the first and last months observed.</p>
    <div class="table-scroll max-260">
      <table>
        <thead>
          <tr>
            <th>Source</th>
            <th>First Month</th>
            <th>Last Month</th>
          </tr>
        </thead>
        <tbody>
          {% for s in sources_span %}
            <tr>
              <td>{{ s.Source }}</td>
              <td>{{ s.FirstMonth or '-' }}</td>
              <td>{{ s.LastMonth or '-' }}</td>
            </tr>
          {% endfor %}
          {% if sources_span|length == 0 %}
            <tr><td colspan="3" class="muted">No sources yet.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Rows by Month (top 12) -->
  <div class="card mt-16">
    <h3>Rows by Month (top 12)</h3>
    <div class="table-scroll">
      <table>
        <thead>
          <tr><th>Month</th><th>RowCount</th><th>Total Amount</th></tr>
        </thead>
        <tbody>
          {% for r in month_stats %}
          <tr>
            <td>{{ r.Month }}</td>
            <td>{{ r.RowCount }}</td>
            <td>{{ (r.Amount or 0)|currency }}</td>
          </tr>
          {% endfor %}
          {% if month_stats|length == 0 %}
          <tr><td colspan="3" class="muted">No data.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
  (function() {
    const fmtCurrency = v => {
      const n = Number(v);
      if (isNaN(n)) return v;
      return '$' + new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n);
    };
    const fmtInteger = v => {
      const n = Number(v);
      if (isNaN(n)) return v;
      return new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 }).format(n);
    };

    function formatTable(tableEl) {
      if (!tableEl) return;
      const headers = [...tableEl.tHead?.rows[0]?.cells || []].map(th => th.textContent.trim());
      if (headers.length === 0) return;
      const amountIdxs = headers.map((h, i) => (/^total amount$/i.test(h) || /^amount$/i.test(h) ? i : -1)).filter(i => i >= 0);
      const countIdxs = headers.map((h, i) => (/^rowcount$/i.test(h) ? i : -1)).filter(i => i >= 0);
      [...tableEl.tBodies].forEach(tb => {
        [...tb.rows].forEach(row => {
          amountIdxs.forEach(i => { const td = row.cells[i]; if (td) td.textContent = fmtCurrency(td.textContent); });
          countIdxs.forEach(i => { const td = row.cells[i]; if (td) td.textContent = fmtInteger(td.textContent); });
        });
      });
    }

    // Format the optional rows-by-month table
    const statusTable = document.querySelector('.content table');
    formatTable(statusTable);
  })();
</script>
{% endblock %}
