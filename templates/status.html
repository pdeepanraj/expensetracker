{% extends "base.html" %}
{% block title %}Status{% endblock %}

{% block header_meta %}
{{ project }}.{{ dataset }}.{{ table }}
{% endblock %}

{% block head %}
<style>
  .kpi { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
  .pill { display:inline-block; padding:8px 12px; border-radius:999px; border:1px solid var(--border); background:#fff; }
  .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
  @media (max-width: 980px){ .grid-2 { grid-template-columns: 1fr; } }
  .table-scroll { max-height: 60vh; overflow:auto; border:1px solid var(--border); border-radius:10px; }
  table { width:100%; border-collapse:collapse; }
  thead th { position:sticky; top:0; background:#f3f4f6; border-bottom:1px solid var(--border); padding:10px; text-align:left; z-index:1; }
  tbody td { padding:10px; border-bottom:1px solid var(--border); }
  .muted { color:var(--muted); }
</style>
{% endblock %}

{% block content %}
<div class="card" style="border:none; background:transparent; box-shadow:none; padding:0; margin-bottom:8px;">
  <h3 style="margin:0 0 6px;">Status</h3>
  <p class="muted">Totals and recent activity</p>
</div>

<section class="content">
  <div class="grid-2">
    <!-- Entire total box -->
   <div class="card">
  <h3>Entire Total</h3>
  <div class="kpi">
    <div class="pill"><strong>Total Amount:</strong> {{ (total_amount_all or 0)|currency }}</div>
  </div>
  <p class="muted" style="margin-top:8px;">Aggregated across all months, cards, and categories.</p>
  <div class="table-scroll" style="margin-top:10px; max-height: 220px;">
    <table>
      <thead><tr><th>Year</th><th>Total Amount</th></tr></thead>
      <tbody>
        {% for y in year_totals %}
        <tr><td>{{ y.Year }}</td><td>{{ (y.Amount or 0)|currency }}</td></tr>
        {% endfor %}
        {% if year_totals|length == 0 %}
        <tr><td colspan="2" class="muted">No data.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>
    </div>

    <!-- Last 10 months by MainCategory -->
    <div class="card">
      <h3>Totals by MainCategory</h3>
      <p class="muted" style="margin-bottom:8px;">Summed over the Entire Spending.</p>
      <div class="table-scroll">
        <table>
          <thead>
            <tr>
              <th>MainCategory</th>
              <th>Total Amount</th>
            </tr>
          </thead>
          <tbody>
            {% for r in main_totals_10m %}
            <tr>
              <td>{{ r.MainCategory }}</td>
              <td>{{ (r.Amount or 0)|currency }}</td>
            </tr>
            {% endfor %}
            {% if main_totals_10m|length == 0 %}
            <tr><td colspan="2" class="muted">No data.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Optional: keep this if you still want to show rows by month; remove if not needed -->
  <div class="card" style="margin-top:16px;">
    <h3>Rows by Month (top 12)</h3>
    <div class="table-scroll">
      <table>
        <thead>
          <tr><th>Month</th><th>RowCount</th><th>Total Amount</th></tr>
        </thead>
        <tbody>
          {% for r in month_stats %}
          <tr>
            <td>{{ r.Month }}</td>
            <td>{{ r.RowCount }}</td>
            <td>{{ (r.Amount or 0)|currency }}</td>
          </tr>
          {% endfor %}
          {% if month_stats|length == 0 %}
          <tr><td colspan="3" class="muted">No data.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
  (function() {
    const fmtCurrency = v => {
      const n = Number(v);
      if (isNaN(n)) return v;
      return '$' + new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n);
    };
    const fmtInteger = v => {
      const n = Number(v);
      if (isNaN(n)) return v;
      return new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 }).format(n);
    };

    function formatTable(tableEl) {
      if (!tableEl) return;
      const headers = [...tableEl.tHead?.rows[0]?.cells || []].map(th => th.textContent.trim());
      if (headers.length === 0) return;
      const amountIdxs = headers.map((h, i) => (/^total amount$/i.test(h) || /^amount$/i.test(h) ? i : -1)).filter(i => i >= 0);
      const countIdxs = headers.map((h, i) => (/^rowcount$/i.test(h) ? i : -1)).filter(i => i >= 0);
      [...tableEl.tBodies].forEach(tb => {
        [...tb.rows].forEach(row => {
          amountIdxs.forEach(i => { const td = row.cells[i]; if (td) td.textContent = fmtCurrency(td.textContent); });
          countIdxs.forEach(i => { const td = row.cells[i]; if (td) td.textContent = fmtInteger(td.textContent); });
        });
      });
    }

    // Format the optional rows-by-month table
    const statusTable = document.querySelector('.content table');
    formatTable(statusTable);
  })();
</script>
{% endblock %}
