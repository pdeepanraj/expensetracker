<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Results</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="/static/styles.css" rel="stylesheet">
</head>
<body>
  <header class="header">
    <div class="container header-row">
      <div>
        <h1>Results</h1>
        <p class="sub">Latest month: <strong>{{ latest_month }}</strong></p>
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <a class="btn" href="/">‚Üê Back</a>
        <a class="btn" href="/download-positive-expenses">Download Positive Expenses (CSV)</a>
      </div>
    </div>
    <div class="accent-bar"></div>
  </header>

  <main class="container">
    {% if warning %}<div class="alert warn">{{ warning }}</div>{% endif %}

    <section class="card">
      <div class="card-head">
        <h2>View</h2>
        <div class="view-controls">
          <label for="view-select">Select section:</label>
          <select id="view-select" class="btn">
            <option value="monthly">Positive Monthly</option>
            <option value="year-main">Totals by Main (latest year)</option>
            <option value="month-total">Total Positive by Month</option>
          </select>
          <label style="margin-left:8px;">Month:</label>
          <select id="month-select" class="btn"></select>
          <label style="margin-left:8px;">MainCategory:</label>
          <select id="main-filter" class="btn"></select>
        </div>
      </div>

      <div id="view-monthly" class="table-wrap"></div>
      <div id="view-year-main" class="table-wrap" style="display:none;"></div>
      <div id="view-month-total" class="table-wrap" style="display:none;"></div>
    </section>

    <section class="card">
      <div class="card-head"><h2>Analyzed files (GitHub raw URLs)</h2></div>
      <ul>{% for uri in uploaded_uris %}<li>{{ uri }}</li>{% endfor %}</ul>
    </section>
  </main>

  <script>const results = {{ results_json | tojson }};</script>
  <script>
    function buildTable(headers, rows) {
      const table = document.createElement('table'); table.className = 'table';
      const thead = document.createElement('thead'); const trh = document.createElement('tr');
      headers.forEach(h => { const th = document.createElement('th'); th.textContent = h.text || h; if (h.class) th.className = h.class; trh.appendChild(th); });
      thead.appendChild(trh); table.appendChild(thead);
      const tbody = document.createElement('tbody');
      rows.forEach(r => {
        const tr = document.createElement('tr');
        headers.forEach(h => { const key = h.key || h; const td = document.createElement('td'); td.textContent = r[key] != null ? r[key] : ''; if (h.class) td.className = h.class; tr.appendChild(td); });
        tbody.appendChild(tr);
      });
      table.appendChild(tbody); return table;
    }
    function renderMonthlyFiltered(month, mainFilter) {
      const wrap = document.getElementById('view-monthly'); wrap.innerHTML = '';
      const headers = [
        {text:'Month', key:'Month'}, {text:'Card', key:'CardName'}, {text:'Main', key:'MainCategory'},
        {text:'Category', key:'Category'}, {text:'Description', key:'Description'},
        {text:'Amount', key:'Amount', class:'num'}, {text:'Comment', key:'Comment'}
      ];
      let rows = results.all_positive_monthly.filter(r => r.Month === month);
      if (mainFilter && mainFilter !== '__all__') rows = rows.filter(r => r.MainCategory === mainFilter);
      wrap.appendChild(buildTable(headers, rows));
    }
    function renderYearMain(filterValue=null) {
      const wrap = document.getElementById('view-year-main'); wrap.innerHTML = '';
      let rows = results.latest_year_main_totals;
      if (filterValue && filterValue !== '__all__') rows = rows.filter(r => r.MainCategory === filterValue);
      const headers = [
        {text:'Main Category', key:'MainCategory'}, {text:'Amount', key:'Amount', class:'num'}, {text:'Subcategories', key:'Subcategories'}
      ];
      wrap.appendChild(buildTable(headers, rows));
    }
    function renderMonthTotal() {
      const wrap = document.getElementById('view-month-total'); wrap.innerHTML = '';
      const headers = [{text:'Month', key:'Month'}, {text:'Amount', key:'Amount', class:'num'}];
      wrap.appendChild(buildTable(headers, results.total_positive_by_month));
    }
    const allRows = results.all_positive_monthly;
    const months = Array.from(new Set(allRows.map(r => r.Month))).sort();
    function populateMonthSelect(defaultMonth) {
      const ms = document.getElementById('month-select'); ms.innerHTML = '';
      months.forEach(m => { const opt = document.createElement('option'); opt.value = m; opt.textContent = m; ms.appendChild(opt); });
      ms.value = defaultMonth;
    }
    function populateMainFilterForMonth(month) {
      const sel = document.getElementById('main-filter'); sel.innerHTML = '';
      const categories = Array.from(new Set(allRows.filter(r => r.Month === month).map(r => r.MainCategory)));
      const optAll = document.createElement('option'); optAll.value = '__all__'; optAll.textContent = 'All'; sel.appendChild(optAll);
      categories.forEach(mc => { const opt = document.createElement('option'); opt.value = mc; opt.textContent = mc; sel.appendChild(opt); });
      sel.value = '__all__';
    }
    function switchView(view) {
      const vMonthly = document.getElementById('view-monthly');
      const vYearMain = document.getElementById('view-year-main');
      const vMonthTotal = document.getElementById('view-month-total');
      vMonthly.style.display = (view === 'monthly') ? 'block' : 'none';
      vYearMain.style.display = (view === 'year-main') ? 'block' : 'none';
      vMonthTotal.style.display = (view === 'month-total') ? 'block' : 'none';
    }
    const defaultMonth = results.latest_month || months[months.length - 1];
    populateMonthSelect(defaultMonth); populateMainFilterForMonth(defaultMonth);
    renderMonthlyFiltered(defaultMonth, '__all__'); renderYearMain('__all__'); renderMonthTotal(); switchView('monthly');
    document.getElementById('view-select').addEventListener('change', (e) => { switchView(e.target.value); });
    document.getElementById('month-select').addEventListener('change', (e) => { const month = e.target.value; populateMainFilterForMonth(month); renderMonthlyFiltered(month, '__all__'); });
    document.getElementById('main-filter').addEventListener('change', (e) => { const month = document.getElementById('month-select').value; renderMonthlyFiltered(month, e.target.value); });
  </script>
  <script>
async function loadCharts(){
  const totalResp = await fetch('/api/total-by-month');
  const total = await totalResp.json();
  const catResp = await fetch('/api/summary-by-category');
  const cats = await catResp.json();
  const mainResp = await fetch('/api/summary-by-main');
  const mains = await mainResp.json();
  // Render into your table/chart views (existing code can adapt these arrays)
  console.log({ total, cats, mains });
}
document.addEventListener('DOMContentLoaded', loadCharts);
</script>

</body>
</html>
