{% extends "base.html" %}
{% block title %}Choose CSVs{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/list.css') }}">
{% endblock %}

{% block header_meta %}
Repo: {{ owner }}/{{ repo }}@{{ branch }}{% if path %}/{{ path }}{% endif %}
{% endblock %}

{% block content %}
<div class="card card-plain mb-8">
  <h3 class="mb-6">CSV files{% if files and files|length > 0 %} ({{ files|length }}){% endif %}</h3>
  {% if error %}<p class="muted err">{{ error }}</p>{% endif %}
</div>

<!-- Tab bar -->
<div class="tabs" role="tablist">
  <button class="tab active" data-tab="select" role="tab" tabindex="0" aria-selected="true">Select CSVs</button>
  <button class="tab" data-tab="advanced" role="tab" tabindex="-1" aria-selected="false">Advanced</button>
  <div class="tabs-spacer"></div>
  <div class="muted">List</div>
</div>

<!-- Select CSVs -->
<div class="section" id="tab-select">
  {% if files and files|length > 0 %}
  <form method="post" action="{{ url_for('process') }}">
    <input type="hidden" name="owner" value="{{ owner }}">
    <input type="hidden" name="repo" value="{{ repo }}">
    <input type="hidden" name="branch" value="{{ branch }}">
    <input type="hidden" name="path" value="{{ path }}">

    <div class="file-toolbar">
      <input id="search" class="search" type="text" placeholder="Filter files by name or path...">
      <label class="inline gap-6 ai-center">
        <input type="checkbox" id="selectAll"> Select all
      </label>
      <div class="muted">Showing {{ files|length }} item(s)</div>
    </div>

    <div id="fileGrid" class="file-grid">
      {% for f in files %}
      <label class="file-item">
        <input type="checkbox" name="csv_paths" value="{{ f.path }}">
        <div class="flex-1 min-0">
          <div class="file-name">{{ f.name }}</div>
          <div class="file-path">{{ f.path }}</div>
        </div>
      </label>
      {% endfor %}
    </div>

    <div class="actions mt-12">
      <button class="btn secondary" type="submit">Run Pipeline</button>
      <a class="btn" href="{{ url_for('dashboard') }}">View Dashboard</a>
      <a class="btn" href="{{ url_for('status') }}">View Status</a>
    </div>
  </form>
  {% else %}
    <p class="muted">No CSV files found in this folder.</p>
    <div class="actions mt-8">
      <a class="btn" href="{{ url_for('index') }}">Back</a>
      <a class="btn secondary" href="{{ url_for('dashboard') }}">Dashboard</a>
    </div>
  {% endif %}
</div>

<!-- Advanced -->
<div class="section hidden" id="tab-advanced">
  <h3>Optional: categories JSON path in repo</h3>
  <p class="muted">Your app now reads categories from BigQuery; this setting is kept for compatibility.</p>
  <form method="post" action="{{ url_for('process') }}" class="inline inline-start">
    <input type="hidden" name="owner" value="{{ owner }}">
    <input type="hidden" name="repo" value="{{ repo }}">
    <input type="hidden" name="branch" value="{{ branch }}">
    <input type="hidden" name="path" value="{{ path }}">
    <div class="flex-1 min-360">
      <label>categories_grouped.json path</label><br>
      <input type="text" name="json_path" placeholder="categories_grouped.json">
      <div class="muted small-note mt-6">If provided, itâ€™s fetched but classification uses BigQuery config.</div>
    </div>
    <div>
      <button class="btn" type="submit">Run with JSON path</button>
    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
// Tabs: accessibility + keyboard
(function(){
  const tabs = Array.from(document.querySelectorAll('.tabs .tab'));
  const panels = {
    select: document.getElementById('tab-select'),
    advanced: document.getElementById('tab-advanced')
  };
  function show(name){
    tabs.forEach(t => {
      const isActive = t.dataset.tab === name;
      t.classList.toggle('active', isActive);
      t.setAttribute('aria-selected', isActive ? 'true' : 'false');
      t.setAttribute('tabindex', isActive ? '0' : '-1');
    });
    Object.entries(panels).forEach(([k, el]) => el.classList.toggle('hidden', k !== name));
  }
  show('select');
  tabs.forEach(t => t.addEventListener('click', () => show(t.dataset.tab)));
  document.querySelector('.tabs').addEventListener('keydown', e => {
    const idx = tabs.findIndex(t => t.classList.contains('active'));
    if (e.key === 'ArrowRight') { e.preventDefault(); const n = tabs[(idx+1)%tabs.length]; n.focus(); show(n.dataset.tab); }
    if (e.key === 'ArrowLeft') { e.preventDefault(); const p = tabs[(idx-1+tabs.length)%tabs.length]; p.focus(); show(p.dataset.tab); }
  });
})();

// Select all helper
(function(){
  const selectAll = document.getElementById('selectAll');
  if (!selectAll) return;
  selectAll.addEventListener('change', () => {
    document.querySelectorAll('input[name="csv_paths"]').forEach(cb => cb.checked = selectAll.checked);
  });
})();

// Search filter
(function(){
  const search = document.getElementById('search');
  const grid = document.getElementById('fileGrid');
  if (!search || !grid) return;
  search.addEventListener('input', () => {
    const q = search.value.toLowerCase();
    grid.querySelectorAll('.file-item').forEach(item => {
      const text = item.innerText.toLowerCase();
      item.style.display = text.includes(q) ? '' : 'none';
    });
  });
})();
</script>
{% endblock %}
